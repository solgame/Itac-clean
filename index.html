<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITAC Cleaning Management</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-blue-700">ITAC Cleaning Management</h1>
            <p class="text-gray-500 mt-1">Real-time Operations Dashboard</p>
        </header>

        <!-- Main Content Area -->
        <main id="main-content">
            
            <!-- Weekly Schedule Display -->
            <section id="weekly-schedule" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Weekly & Special Cleaning Plan</h2>
                <div id="schedule-display" class="space-y-1 text-sm text-gray-700 min-h-[10rem] max-h-64 overflow-y-auto">
                    <!-- Schedule items will be dynamically loaded here -->
                    <p class="text-gray-400 italic">Loading schedule...</p>
                </div>
            </section>

            <!-- Cleaning Request Section -->
            <section id="cleaning-requests" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    Cleaning Requests
                    <button onclick="showRequestForm()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 shadow-md text-sm">
                        Submit New Request
                    </button>
                </h2>
                <div id="requests-list" class="space-y-4">
                    <!-- Request items will be dynamically loaded here -->
                    <p class="text-gray-400 italic">No cleaning requests found.</p>
                </div>
            </section>

            <!-- Consumables Inventory Management -->
            <section id="consumables-inventory" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Consumables Inventory</h2>
                <div id="consumables-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Consumables will be dynamically loaded here -->
                </div>
            </section>

            <!-- Chemicals Inventory Management -->
            <section id="chemicals-inventory" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Chemicals Inventory</h2>
                <div id="chemicals-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Chemicals will be dynamically loaded here -->
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Inventory Transaction Reports</h2>
                <div class="flex space-x-4 mb-4">
                    <input type="date" id="report-start-date" class="border p-2 rounded-lg">
                    <input type="date" id="report-end-date" class="border p-2 rounded-lg">
                    <button onclick="generateReport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                        Generate Report
                    </button>
                </div>
                <div id="report-output" class="max-h-96 overflow-y-auto border rounded-lg p-2 mb-4">
                    <p class="text-sm text-gray-500 italic">Select a date range and click 'Generate Report'.</p>
                </div>
                <div class="flex space-x-4">
                    <button onclick="printReport()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150 shadow-md">
                        Print Report
                    </button>
                    <button onclick="exportToExcel()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                        Export to Excel
                    </button>
                </div>
            </section>

        </main>

        <!-- Footer/Settings Button -->
        <footer class="text-center py-4 border-t mt-8">
            <button onclick="showSettingsModal()" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full shadow-lg hover:bg-indigo-700 transition duration-200">
                Settings
            </button>
        </footer>
    </div>
    
    <!-- Modals Container -->
    <div id="modals-container">
        
        <!-- Generic Password Modal -->
        <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h3 class="text-xl font-bold mb-4" id="password-modal-title">Access Required</h3>
                <p class="mb-4 text-gray-600">Please enter Administrator or Supervisor password to proceed.</p>
                <input type="password" id="auth-password-input" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="Password">
                <p id="auth-error-message" class="text-red-500 mb-4 hidden">Invalid password. Please try again.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hidePasswordModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</button>
                    <button id="auth-confirm-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal (Admin Only) -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-indigo-700">Application Settings</h3>
                <div id="settings-content" class="space-y-6">
                    
                    <!-- Weekly Schedule Management -->
                    <div class="border-b pb-4">
                        <h4 class="text-xl font-semibold mb-3">Weekly Cleaning Plan</h4>
                        <textarea id="weekly-plan-input" rows="10" class="w-full p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Enter up to 10 lines of the weekly schedule (e.g., Monday: Deep clean floors)"></textarea>
                        <button onclick="saveWeeklyPlan()" class="mt-2 px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Save Plan</button>
                    </div>

                    <!-- Inventory Management (Consumables & Chemicals) -->
                    <div class="border-b pb-4">
                        <h4 class="text-xl font-semibold mb-3">Inventory Item Management</h4>
                        <div class="space-y-4">
                            <!-- Consumables -->
                            <h5 class="font-medium text-lg mt-2 text-gray-700">Consumables</h5>
                            <div id="settings-consumables-list" class="space-y-2"></div>
                            <input type="text" id="new-consumable-name" class="p-2 border rounded-lg" placeholder="New Consumable Name">
                            <button onclick="addItem('consumable')" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Add Consumable</button>
                            
                            <!-- Chemicals -->
                            <h5 class="font-medium text-lg mt-4 text-gray-700">Chemicals</h5>
                            <div id="settings-chemicals-list" class="space-y-2"></div>
                            <input type="text" id="new-chemical-name" class="p-2 border rounded-lg" placeholder="New Chemical Name">
                            <button onclick="addItem('chemical')" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Add Chemical</button>
                        </div>
                    </div>

                    <!-- Safety Stock Management -->
                    <div class="border-b pb-4">
                        <h4 class="text-xl font-semibold mb-3">Safety Stock & Reorder Quantity</h4>
                        <div id="settings-safety-stock-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Safety Stock inputs will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- Password Management -->
                    <div>
                        <h4 class="text-xl font-semibold mb-3 text-red-600">Password Management</h4>
                        <p class="text-sm text-gray-600 mb-3">You must be the Administrator to change passwords.</p>
                        <div class="space-y-3 p-4 border rounded-lg bg-red-50">
                            <input type="password" id="current-admin-pw" class="w-full p-2 border rounded-lg" placeholder="Current Admin Password">
                            <input type="password" id="new-admin-pw" class="w-full p-2 border rounded-lg" placeholder="New Administrator Password (admin123)">
                            <input type="password" id="new-supervisor-pw" class="w-full p-2 border rounded-lg" placeholder="New Supervisor Password (super123)">
                            <button onclick="changePasswords()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Update Passwords</button>
                        </div>
                    </div>

                </div>
                <div class="flex justify-end mt-6">
                    <button onclick="hideSettingsModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Close Settings</button>
                </div>
            </div>
        </div>

        <!-- Inventory Transaction Modal -->
        <div id="transaction-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h3 class="text-xl font-bold mb-4" id="transaction-modal-title">Record Transaction</h3>
                <p id="transaction-item-name" class="text-lg font-semibold mb-4 text-blue-600"></p>
                <div class="flex space-x-4 mb-4">
                    <button id="in-btn" onclick="setTransactionType('in')" class="flex-1 p-3 bg-green-100 text-green-700 rounded-lg border border-green-300 hover:bg-green-200">Record IN</button>
                    <button id="out-btn" onclick="setTransactionType('out')" class="flex-1 p-3 bg-red-100 text-red-700 rounded-lg border border-red-300 hover:bg-red-200">Record OUT</button>
                </div>
                <input type="number" id="transaction-quantity" class="w-full p-3 border rounded-lg mb-4" placeholder="Quantity">
                <p id="transaction-error" class="text-red-500 mb-4 hidden"></p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideTransactionModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</button>
                    <button onclick="recordTransaction()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Transaction</button>
                </div>
            </div>
        </div>

        <!-- New Cleaning Request Modal -->
        <div id="request-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-4 text-green-700">Submit New Cleaning Request</h3>
                <textarea id="request-message-input" rows="4" class="w-full p-3 border rounded-lg mb-4 focus:ring-green-500" placeholder="Please describe the required cleaning task..."></textarea>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Attach Photos (Max 5)</label>
                    <input type="file" id="request-image-input" multiple accept="image/*" class="w-full p-2 border rounded-lg" onchange="previewImages('request')">
                    <div id="request-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button onclick="hideRequestForm()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Cancel</button>
                    <button onclick="submitNewRequest()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Submit Request</button>
                </div>
            </div>
        </div>

        <!-- Request Details/Completion Modal -->
        <div id="request-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-4 text-blue-700" id="details-request-id">Cleaning Request Details</h3>
                <div id="details-content" class="space-y-4">
                    <p><strong>Status:</strong> <span id="details-status" class="font-bold"></span></p>
                    <p><strong>Requested At:</strong> <span id="details-timestamp"></span></p>
                    
                    <!-- Request Message & Images -->
                    <div class="border-t pt-4">
                        <p class="font-semibold mb-2">Request Message:</p>
                        <p id="details-request-message" class="p-3 bg-gray-50 rounded-lg whitespace-pre-wrap"></p>
                        <p class="font-semibold mt-4 mb-2">Request Photos:</p>
                        <div id="details-request-images" class="flex flex-wrap gap-2"></div>
                    </div>

                    <!-- Completion Form (Supervisor/Admin only) -->
                    <div id="completion-form" class="border-t pt-4 hidden">
                        <h4 class="text-xl font-semibold mb-3 text-red-600">Task Completion</h4>
                        <textarea id="completion-message-input" rows="3" class="w-full p-3 border rounded-lg mb-4 focus:ring-red-500" placeholder="Enter completion notes..."></textarea>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Completion Photos (Max 5)</label>
                        <input type="file" id="completion-image-input" multiple accept="image/*" class="w-full p-2 border rounded-lg" onchange="previewImages('completion')">
                        <div id="completion-image-preview" class="flex flex-wrap gap-2 mt-2"></div>
                        <button onclick="completeRequest()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Mark as Completed</button>
                    </div>

                    <!-- Completed Details -->
                    <div id="completed-details" class="border-t pt-4 hidden">
                        <p class="font-semibold mb-2 text-green-600">Completion Message:</p>
                        <p id="details-completion-message" class="p-3 bg-green-50 rounded-lg whitespace-pre-wrap"></p>
                        <p class="font-semibold mt-4 mb-2">Completion Photos:</p>
                        <div id="details-completion-images" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6">
                    <button id="approve-btn" onclick="approveRequest()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 hidden">Approve (In Progress)</button>
                    <button onclick="hideRequestDetailsModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">Close</button>
                </div>
            </div>
        </div>

        <!-- Full Image View Modal -->
        <div id="full-image-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[60]">
            <span class="absolute top-4 right-6 text-white text-4xl cursor-pointer" onclick="hideFullImageModal()">&times;</span>
            <img id="full-image-display" src="" alt="Full size image" class="max-w-full max-h-full object-contain rounded-lg">
        </div>

    </div>

    <!-- Firebase Imports and Initialization -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp, orderBy, runTransaction, arrayRemove, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Mock Config */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let currentData = {
            settings: null,
            items: [],
            requests: [],
            transactions: []
        };
        let currentItemForTransaction = null;
        let currentTransactionType = null;
        let currentRequestDocId = null;

        // Mock Passwords (In a real app, these would be securely hashed and stored.)
        const ADMIN_PW = 'admin123';
        const SUPER_PW = 'super123';

        // Initialize Firebase and Authentication
        window.onload = async () => {
            // setLogLevel('Debug'); // Enable for debugging
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated. ID:", userId);
                        // Start listeners after authentication is confirmed
                        setupRealtimeListeners();
                        initializeDefaultData();
                    } else {
                        userId = null;
                        console.log("No user signed in. Using Anonymous Auth.");
                        setupRealtimeListeners();
                        initializeDefaultData();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
            }
        };

        // --- Data Paths ---
        const getPublicCollectionRef = (collectionName) => {
            return collection(db, 'artifacts', appId, 'public', 'data', collectionName);
        };
        const getPrivateDocRef = (docId) => {
            // For simplicity, we are mocking passwords here, but the structure shows where private data *should* go
            // We'll store the mock passwords in a public settings doc for this simulation since we can't write to private user docs based on admin role.
            return doc(getPublicCollectionRef('settings'), docId); 
        };

        // --- Data Initialization ---
        const initializeDefaultData = async () => {
            const settingsRef = getPrivateDocRef('app_settings');
            const settingsSnap = await getDoc(settingsRef);

            if (!settingsSnap.exists()) {
                console.log("Creating default settings and items...");
                
                const initialSettings = {
                    weekly_schedule: [
                        'Monday: Deep clean main areas.',
                        'Tuesday: Restroom sanitization and supply check.',
                        'Wednesday: Office desks and equipment wipe-down.',
                        'Thursday: Floor polishing in high-traffic zones.',
                        'Friday: Waste disposal and exterior area check.',
                        'Saturday: Special cleaning projects.',
                        'Sunday: Off-day.'
                    ],
                    // Mock initial passwords for simulation purposes
                    admin_password_mock: ADMIN_PW,
                    supervisor_password_mock: SUPER_PW
                };

                const initialItems = [
                    // Consumables (Type: 1)
                    { id: 'toilet_paper', name: 'Toilet Paper', type: 1, current_stock: 50, safety_stock: 20, reorder_qty: 100 },
                    { id: 'liquid_soap', name: 'Liquid Soap', type: 1, current_stock: 15, safety_stock: 10, reorder_qty: 30 },
                    { id: 'paper_towel', name: 'Paper Towel', type: 1, current_stock: 45, safety_stock: 25, reorder_qty: 75 },
                    { id: 'trash_bag_l', name: 'Black Trash Bags (Large)', type: 1, current_stock: 30, safety_stock: 15, reorder_qty: 50 },
                    { id: 'trash_bag_s', name: 'Trash Can Liners (Small)', type: 1, current_stock: 80, safety_stock: 40, reorder_qty: 120 },
                    
                    // Chemicals (Type: 2)
                    { id: 'nabc', name: 'NABC', type: 2, current_stock: 12, safety_stock: 5, reorder_qty: 20 },
                    { id: 'bleach', name: 'Bleach', type: 2, current_stock: 8, safety_stock: 4, reorder_qty: 15 },
                    { id: 'xcelente', name: 'Xcelente', type: 2, current_stock: 18, safety_stock: 10, reorder_qty: 30 },
                    { id: 'ecolyzer', name: 'Eco-Lyzer', type: 2, current_stock: 5, safety_stock: 3, reorder_qty: 10 },
                    { id: 'fast_easy', name: 'Fast & Easy', type: 2, current_stock: 25, safety_stock: 15, reorder_qty: 40 },
                    { id: 'wipes', name: 'Wipes', type: 2, current_stock: 60, safety_stock: 30, reorder_qty: 80 },
                    { id: 'gloves_m', name: 'Gloves M', type: 2, current_stock: 100, safety_stock: 50, reorder_qty: 150 },
                    { id: 'pine_sol', name: 'Pine-sol', type: 2, current_stock: 7, safety_stock: 5, reorder_qty: 15 },
                    { id: 'brown_bag', name: 'Brown Bag', type: 2, current_stock: 30, safety_stock: 20, reorder_qty: 50 },
                ];

                await setDoc(settingsRef, initialSettings);
                
                const itemCollectionRef = getPublicCollectionRef('items');
                for (const item of initialItems) {
                    await setDoc(doc(itemCollectionRef, item.id), item);
                }
                console.log("Default data initialized.");
            }
        };

        // --- Realtime Listeners ---
        const setupRealtimeListeners = () => {
            // 1. Settings Listener (Weekly Plan & Passwords)
            onSnapshot(getPrivateDocRef('app_settings'), (docSnap) => {
                if (docSnap.exists()) {
                    currentData.settings = docSnap.data();
                    renderWeeklySchedule();
                    console.log("Settings updated.");
                }
            });

            // 2. Items Listener (Inventory)
            onSnapshot(getPublicCollectionRef('items'), (snapshot) => {
                currentData.items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventory();
                renderSafetyStockSettings();
                console.log("Inventory updated.");
            });

            // 3. Cleaning Requests Listener
            onSnapshot(query(getPublicCollectionRef('cleaning_requests'), orderBy('requested_at', 'desc')), (snapshot) => {
                currentData.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCleaningRequests();
                console.log("Requests updated.");
            });

            // Note: Transactions listener will only be used by the reporting function.
        };

        // --- Rendering Functions ---

        const renderWeeklySchedule = () => {
            const container = document.getElementById('schedule-display');
            container.innerHTML = '';
            if (currentData.settings && currentData.settings.weekly_schedule) {
                const schedule = currentData.settings.weekly_schedule;
                schedule.forEach((line, index) => {
                    if (index < 10) { // Limit to 10 lines
                        const p = document.createElement('p');
                        p.className = 'text-gray-700 p-1 border-b border-gray-100';
                        p.textContent = line;
                        container.appendChild(p);
                    }
                });
                if (schedule.length === 0) {
                     container.innerHTML = '<p class="text-gray-400 italic">No weekly schedule set.</p>';
                }
            } else {
                container.innerHTML = '<p class="text-gray-400 italic">No weekly schedule set.</p>';
            }
        };

        const renderInventory = () => {
            const consumablesContainer = document.getElementById('consumables-list');
            const chemicalsContainer = document.getElementById('chemicals-list');
            consumablesContainer.innerHTML = '';
            chemicalsContainer.innerHTML = '';

            currentData.items.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                const isReorderNeeded = item.current_stock < item.safety_stock;
                const alertClass = isReorderNeeded ? 'border-red-500 bg-red-50 ring-2 ring-red-500' : 'border-gray-200 bg-white';
                const alertBadge = isReorderNeeded ? 
                    `<span class="text-xs font-bold px-2 py-1 bg-red-500 text-white rounded-full">REORDER: ${item.reorder_qty || 'N/A'}</span>` : '';
                
                const itemHtml = `
                    <div onclick="showAuthModal('${item.id}')" 
                         class="p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition duration-200 ${alertClass}">
                        <div class="flex justify-between items-start">
                            <p class="text-lg font-semibold text-gray-800">${item.name}</p>
                            ${alertBadge}
                        </div>
                        <p class="text-3xl font-bold text-blue-600 mt-2">${item.current_stock}</p>
                        <p class="text-sm text-gray-500">Current Stock (Safety: ${item.safety_stock})</p>
                    </div>
                `;

                if (item.type === 1) { // Consumables
                    consumablesContainer.innerHTML += itemHtml;
                } else if (item.type === 2) { // Chemicals
                    chemicalsContainer.innerHTML += itemHtml;
                }
            });
        };

        const renderCleaningRequests = () => {
            const container = document.getElementById('requests-list');
            container.innerHTML = '';

            if (currentData.requests.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 italic">No cleaning requests found.</p>';
                 return;
            }

            currentData.requests.forEach(req => {
                let statusClass = '';
                let statusText = '';
                if (req.status === 'New') {
                    statusClass = 'bg-blue-100 text-blue-800';
                    statusText = 'New Request';
                } else if (req.status === 'In Progress') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'In Progress';
                } else if (req.status === 'Completed') {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Completed';
                }

                const date = req.requested_at ? new Date(req.requested_at.seconds * 1000).toLocaleString() : 'N/A';

                container.innerHTML += `
                    <div onclick="showRequestDetailsModal('${req.id}')" class="p-4 border rounded-xl shadow-sm hover:shadow-md transition duration-200 cursor-pointer flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800 line-clamp-1">${req.request_message}</p>
                            <p class="text-sm text-gray-500">Requested: ${date}</p>
                        </div>
                        <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">${statusText}</span>
                    </div>
                `;
            });
        };

        // --- Authentication Logic ---

        const checkPassword = (inputPw) => {
            const settings = currentData.settings;
            if (!settings) return null; // Data not loaded

            const isAdmin = inputPw === settings.admin_password_mock;
            const isSupervisor = inputPw === settings.supervisor_password_mock;

            if (isAdmin) return 'Admin';
            if (isSupervisor) return 'Supervisor';
            return null; // Failed
        };

        // --- Generic Password Modal Logic ---

        let passwordCallback = null;

        const showPasswordModal = (title, callback) => {
            document.getElementById('password-modal-title').textContent = title;
            document.getElementById('auth-password-input').value = '';
            document.getElementById('auth-error-message').classList.add('hidden');
            document.getElementById('password-modal').classList.remove('hidden');
            passwordCallback = callback;
        };

        const hidePasswordModal = () => {
            document.getElementById('password-modal').classList.add('hidden');
            passwordCallback = null;
        };

        document.getElementById('auth-confirm-button').onclick = () => {
            const inputPw = document.getElementById('auth-password-input').value;
            const role = checkPassword(inputPw);

            if (role && passwordCallback) {
                hidePasswordModal();
                passwordCallback(role);
            } else {
                document.getElementById('auth-error-message').classList.remove('hidden');
            }
        };

        // --- Inventory Transaction Logic ---

        window.showAuthModal = (itemId) => {
            currentItemForTransaction = currentData.items.find(item => item.id === itemId);
            if (!currentItemForTransaction) return;

            showPasswordModal(`Authorize Stock for ${currentItemForTransaction.name}`, (role) => {
                if (role === 'Admin' || role === 'Supervisor') {
                    showTransactionModal();
                } else {
                    console.error('Unauthorized attempt.');
                }
            });
        };

        window.showTransactionModal = () => {
            document.getElementById('transaction-item-name').textContent = currentItemForTransaction.name;
            document.getElementById('transaction-modal').classList.remove('hidden');
            document.getElementById('transaction-quantity').value = '';
            document.getElementById('transaction-error').classList.add('hidden');
            setTransactionType(null); // Reset buttons
        };

        window.hideTransactionModal = () => {
            document.getElementById('transaction-modal').classList.add('hidden');
            currentItemForTransaction = null;
            currentTransactionType = null;
        };

        window.setTransactionType = (type) => {
            currentTransactionType = type;
            const inBtn = document.getElementById('in-btn');
            const outBtn = document.getElementById('out-btn');
            
            inBtn.classList.remove('ring-2', 'ring-green-500');
            outBtn.classList.remove('ring-2', 'ring-red-500');

            if (type === 'in') inBtn.classList.add('ring-2', 'ring-green-500');
            if (type === 'out') outBtn.classList.add('ring-2', 'ring-red-500');
        };

        window.recordTransaction = async () => {
            const quantity = parseInt(document.getElementById('transaction-quantity').value);
            const errorElement = document.getElementById('transaction-error');
            errorElement.classList.add('hidden');

            if (!currentTransactionType || isNaN(quantity) || quantity <= 0) {
                errorElement.textContent = 'Please select IN/OUT and enter a valid quantity.';
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const itemRef = doc(getPublicCollectionRef('items'), currentItemForTransaction.id);
                    const itemSnap = await transaction.get(itemRef);
                    if (!itemSnap.exists()) {
                        throw "Item does not exist!";
                    }

                    const newStock = currentTransactionType === 'in'
                        ? itemSnap.data().current_stock + quantity
                        : itemSnap.data().current_stock - quantity;

                    if (newStock < 0) {
                        throw "Insufficient stock for OUT transaction.";
                    }

                    // 1. Update stock
                    transaction.update(itemRef, { current_stock: newStock });

                    // 2. Record transaction
                    const transactionData = {
                        item_id: currentItemForTransaction.id,
                        item_name: currentItemForTransaction.name,
                        type: currentTransactionType,
                        quantity: quantity,
                        current_stock_after: newStock,
                        timestamp: serverTimestamp(),
                        user_id: userId
                    };
                    transaction.set(doc(getPublicCollectionRef('transactions')), transactionData);
                });

                hideTransactionModal();
                console.log("Transaction successfully committed!");
            } catch (e) {
                errorElement.textContent = e.message || e;
                errorElement.classList.remove('hidden');
                console.error("Transaction failed: ", e);
            }
        };

        // --- Cleaning Request Logic ---

        window.showRequestForm = () => {
            document.getElementById('request-message-input').value = '';
            document.getElementById('request-image-input').value = '';
            document.getElementById('request-image-preview').innerHTML = '';
            document.getElementById('request-modal').classList.remove('hidden');
        };

        window.hideRequestForm = () => {
            document.getElementById('request-modal').classList.add('hidden');
        };

        window.submitNewRequest = async () => {
            const message = document.getElementById('request-message-input').value.trim();
            const files = document.getElementById('request-image-input').files;
            
            if (!message) {
                alert('Please enter a request message.');
                return;
            }

            // Mocking image URLs since real file uploads are not possible in this environment
            const imageMocks = Array.from(files).slice(0, 5).map((file, index) => 
                `https://placehold.co/100x100/A0E7E5/000?text=Req+Img+${index+1}`
            );

            const newRequest = {
                status: 'New',
                request_message: message,
                request_images: imageMocks,
                requested_at: serverTimestamp(),
                completed_message: '',
                completed_images: [],
                approved_by: '',
                completed_at: null
            };

            try {
                await addDoc(getPublicCollectionRef('cleaning_requests'), newRequest);
                hideRequestForm();
            } catch (error) {
                console.error("Error submitting request:", error);
            }
        };

        // Image Preview & Full View
        window.previewImages = (type) => {
            const inputId = type === 'request' ? 'request-image-input' : 'completion-image-input';
            const previewId = type === 'request' ? 'request-image-preview' : 'completion-image-preview';
            const files = document.getElementById(inputId).files;
            const previewContainer = document.getElementById(previewId);
            
            previewContainer.innerHTML = '';
            Array.from(files).slice(0, 5).forEach((file, index) => {
                const imgUrl = URL.createObjectURL(file);
                const img = document.createElement('img');
                img.src = imgUrl;
                img.className = 'w-16 h-16 object-cover rounded-md cursor-pointer';
                img.onclick = () => showFullImageModal(imgUrl);
                previewContainer.appendChild(img);
            });
        };

        window.showFullImageModal = (src) => {
            document.getElementById('full-image-display').src = src;
            document.getElementById('full-image-modal').classList.remove('hidden');
        };
        window.hideFullImageModal = () => {
            document.getElementById('full-image-modal').classList.add('hidden');
        };

        window.showRequestDetailsModal = (docId) => {
            currentRequestDocId = docId;
            const req = currentData.requests.find(r => r.id === docId);
            if (!req) return;

            // Reset UI
            document.getElementById('details-request-id').textContent = `Request ID: ${docId.substring(0, 8)}...`;
            document.getElementById('completion-form').classList.add('hidden');
            document.getElementById('completed-details').classList.add('hidden');
            document.getElementById('approve-btn').classList.add('hidden');

            // Populate details
            document.getElementById('details-status').textContent = req.status;
            document.getElementById('details-timestamp').textContent = req.requested_at ? new Date(req.requested_at.seconds * 1000).toLocaleString() : 'N/A';
            document.getElementById('details-request-message').textContent = req.request_message;

            const renderImages = (containerId, images) => {
                const container = document.getElementById(containerId);
                container.innerHTML = images.length > 0 ? '' : '<p class="text-sm italic text-gray-400">No photos attached.</p>';
                images.forEach(url => {
                    container.innerHTML += `<img src="${url}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ccc/000?text=Image+Error'" class="w-20 h-20 object-cover rounded-md cursor-pointer" onclick="showFullImageModal('${url}')">`;
                });
            };
            renderImages('details-request-images', req.request_images || []);
            
            // Handle Status
            if (req.status === 'New') {
                document.getElementById('approve-btn').classList.remove('hidden');
            } else if (req.status === 'In Progress') {
                document.getElementById('completion-form').classList.remove('hidden');
            } else if (req.status === 'Completed') {
                document.getElementById('completed-details').classList.remove('hidden');
                document.getElementById('details-completion-message').textContent = req.completed_message || 'No message provided.';
                renderImages('details-completion-images', req.completed_images || []);
            }

            document.getElementById('request-details-modal').classList.remove('hidden');
        };

        window.hideRequestDetailsModal = () => {
            document.getElementById('request-details-modal').classList.add('hidden');
            currentRequestDocId = null;
        };
        
        window.approveRequest = () => {
             showPasswordModal('Authorize Request Approval', async (role) => {
                if (role === 'Admin' || role === 'Supervisor') {
                    await updateDoc(doc(getPublicCollectionRef('cleaning_requests'), currentRequestDocId), { 
                        status: 'In Progress',
                        approved_by: userId 
                    });
                    hideRequestDetailsModal();
                } else {
                    console.error('Unauthorized approval attempt.');
                }
            });
        };
        
        window.completeRequest = () => {
            showPasswordModal('Authorize Task Completion', async (role) => {
                if (role === 'Admin' || role === 'Supervisor') {
                    const message = document.getElementById('completion-message-input').value.trim();
                    const files = document.getElementById('completion-image-input').files;

                    // Mocking completion image URLs
                    const completionImageMocks = Array.from(files).slice(0, 5).map((file, index) => 
                        `https://placehold.co/100x100/00C9A7/000?text=Comp+Img+${index+1}`
                    );

                    await updateDoc(doc(getPublicCollectionRef('cleaning_requests'), currentRequestDocId), { 
                        status: 'Completed',
                        completed_message: message,
                        completed_images: completionImageMocks,
                        completed_at: serverTimestamp()
                    });
                    hideRequestDetailsModal();
                } else {
                    console.error('Unauthorized completion attempt.');
                }
            });
        };

        // --- Settings Logic (Admin Only) ---

        window.showSettingsModal = () => {
             showPasswordModal('Administrator Access Required', (role) => {
                if (role === 'Admin') {
                    document.getElementById('settings-modal').classList.remove('hidden');
                    // Load current settings data into inputs
                    if (currentData.settings) {
                        document.getElementById('weekly-plan-input').value = currentData.settings.weekly_schedule ? currentData.settings.weekly_schedule.join('\n') : '';
                    }
                } else {
                    console.error('Unauthorized settings access attempt.');
                }
            });
        };
        
        window.hideSettingsModal = () => {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.saveWeeklyPlan = async () => {
            const planText = document.getElementById('weekly-plan-input').value.trim();
            const scheduleArray = planText.split('\n').filter(line => line.trim() !== '');

            try {
                 await updateDoc(getPrivateDocRef('app_settings'), {
                    weekly_schedule: scheduleArray
                });
                alert('Weekly Cleaning Plan updated successfully!'); // Use alert() here as it is inside the settings modal
            } catch (error) {
                console.error("Error saving weekly plan:", error);
            }
        };

        const renderSafetyStockSettings = () => {
            const container = document.getElementById('settings-safety-stock-list');
            container.innerHTML = '';

            currentData.items.sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                container.innerHTML += `
                    <div class="p-3 border rounded-lg bg-gray-50">
                        <label class="block text-sm font-medium text-gray-700">${item.name}</label>
                        <input type="number" id="safety-${item.id}" value="${item.safety_stock}" onchange="updateSafetyStock('${item.id}', this.value)" class="w-full p-2 mt-1 border rounded-lg text-sm" placeholder="Safety Stock">
                        <input type="number" id="reorder-${item.id}" value="${item.reorder_qty}" onchange="updateReorderQty('${item.id}', this.value)" class="w-full p-2 mt-1 border rounded-lg text-sm" placeholder="Reorder Quantity">
                    </div>
                `;
            });

             renderItemManagementLists();
        };
        
        const renderItemManagementLists = () => {
            const consumablesList = document.getElementById('settings-consumables-list');
            const chemicalsList = document.getElementById('settings-chemicals-list');
            consumablesList.innerHTML = '';
            chemicalsList.innerHTML = '';
            
            currentData.items.forEach(item => {
                const deleteBtn = `<button onclick="deleteItem('${item.id}')" class="ml-3 text-red-500 hover:text-red-700 text-sm">Delete</button>`;
                const itemHtml = `<div class="flex items-center justify-between p-2 bg-white border rounded-lg"><span class="font-medium">${item.name}</span>${deleteBtn}</div>`;
                
                if (item.type === 1) consumablesList.innerHTML += itemHtml;
                if (item.type === 2) chemicalsList.innerHTML += itemHtml;
            });
        };

        window.updateSafetyStock = async (itemId, value) => {
            const newStock = parseInt(value);
            if (!isNaN(newStock) && newStock >= 0) {
                 await updateDoc(doc(getPublicCollectionRef('items'), itemId), { safety_stock: newStock });
            }
        };

        window.updateReorderQty = async (itemId, value) => {
            const newQty = parseInt(value);
            if (!isNaN(newQty) && newQty >= 0) {
                 await updateDoc(doc(getPublicCollectionRef('items'), itemId), { reorder_qty: newQty });
            }
        };
        
        window.addItem = async (type) => {
            const inputId = type === 'consumable' ? 'new-consumable-name' : 'new-chemical-name';
            const name = document.getElementById(inputId).value.trim();
            if (!name) return;

            const newItem = {
                id: name.toLowerCase().replace(/[^a-z0-9]/g, '_'), // Generate ID
                name: name,
                type: type === 'consumable' ? 1 : 2,
                current_stock: 0,
                safety_stock: 10,
                reorder_qty: 50,
            };

            try {
                await setDoc(doc(getPublicCollectionRef('items'), newItem.id), newItem);
                document.getElementById(inputId).value = '';
            } catch (error) {
                console.error("Error adding item:", error);
            }
        };

        window.deleteItem = async (itemId) => {
            if (confirm(`Are you sure you want to delete this item? This action is irreversible.`)) {
                try {
                    await deleteDoc(doc(getPublicCollectionRef('items'), itemId));
                } catch (error) {
                    console.error("Error deleting item:", error);
                }
            }
        };

        window.changePasswords = async () => {
            const currentAdminPw = document.getElementById('current-admin-pw').value;
            const newAdminPw = document.getElementById('new-admin-pw').value;
            const newSupervisorPw = document.getElementById('new-supervisor-pw').value;

            if (currentAdminPw !== currentData.settings.admin_password_mock) {
                alert('Current Admin Password is incorrect.');
                return;
            }

            const updates = {};
            if (newAdminPw) updates.admin_password_mock = newAdminPw;
            if (newSupervisorPw) updates.supervisor_password_mock = newSupervisorPw;

            if (Object.keys(updates).length > 0) {
                 await updateDoc(getPrivateDocRef('app_settings'), updates);
                alert('Passwords updated successfully!');
            } else {
                alert('No new passwords were entered.');
            }
        };


        // --- Reports Logic ---
        window.generateReport = async () => {
            const start = document.getElementById('report-start-date').value;
            const end = document.getElementById('report-end-date').value;
            const output = document.getElementById('report-output');

            if (!start || !end) {
                output.innerHTML = '<p class="text-red-500">Please select both start and end dates.</p>';
                return;
            }

            const startDate = Timestamp.fromDate(new Date(start));
            const endDate = Timestamp.fromDate(new Date(new Date(end).setHours(23, 59, 59, 999))); // End of day

            const transactionsRef = getPublicCollectionRef('transactions');
            const q = query(
                transactionsRef,
                where('timestamp', '>=', startDate),
                where('timestamp', '<=', endDate),
                orderBy('timestamp', 'desc')
            );
            
            const querySnapshot = await getDocs(q);
            const transactions = querySnapshot.docs.map(doc => doc.data());

            if (transactions.length === 0) {
                output.innerHTML = '<p class="text-gray-500 italic">No transactions found in the selected period.</p>';
                return;
            }

            let tableHtml = `
                <table id="report-table" class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-3 py-2 text-left font-medium text-gray-600">Item</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-600">Type</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-600">Qty</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-600">Stock After</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-600">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            transactions.forEach(t => {
                const dateString = t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                const typeClass = t.type === 'in' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                tableHtml += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 whitespace-nowrap">${t.item_name}</td>
                        <td class="px-3 py-2 whitespace-nowrap"><span class="${typeClass}">${t.type.toUpperCase()}</span></td>
                        <td class="px-3 py-2 whitespace-nowrap">${t.quantity}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${t.current_stock_after}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${dateString}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            output.innerHTML = tableHtml;
        };

        window.printReport = () => {
            const printContents = document.getElementById('report-output').innerHTML;
            const originalContents = document.body.innerHTML;

            // Create a print-friendly window
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Inventory Report</title>');
            printWindow.document.write('<style>body { font-family: sans-serif; padding: 20px; } table, th, td { border: 1px solid #ddd; border-collapse: collapse; padding: 8px; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1 style="text-align: center;">Inventory Transaction Report</h1>');
            printWindow.document.write(printContents);
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        };

        window.exportToExcel = () => {
            const table = document.getElementById('report-table');
            if (!table) {
                alert('Please generate a report first.');
                return;
            }

            // Create a blob URL for the table data
            const html = table.outerHTML;
            const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
            
            // Create a temporary link element to trigger the download
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'Inventory_Report.xls');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

    </script>
</body>
</html>
