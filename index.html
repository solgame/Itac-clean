<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ITAC Cleaning Management</title>
<link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet"/>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;background:#f6f7fb;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .container{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(20,20,40,.06)}
  .weekly{min-height:180px}
  .requests-list{max-height:420px;overflow:auto}
  .inventory-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #eee}
  button{padding:6px 10px;border-radius:6px;border:0;background:#2b6cb0;color:white;cursor:pointer}
  .small{font-size:13px;padding:4px 8px}
  .danger{background:#c53030}
  .warn{color:#c05621;font-weight:700}
  input, textarea, select{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center}
  .modal-content{width:640px;max-width:95%;background:white;padding:14px;border-radius:8px}
  .flex{display:flex;gap:8px}
  .col{flex:1}
  .img-thumb{width:64px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #ddd}
  .note{font-size:13px;color:#555}
</style>
</head>
<body>

<header>
  <h1>ITAC Cleaning Management</h1>
  <div>
    <button id="btn-settings">Settings</button>
    <button id="btn-report" class="small">Reports</button>
  </div>
</header>

<div class="container">
  <main>
    <section class="card weekly" id="weeklyCard">
      <h3>Weekly Cleaning Plan</h3>
      <div id="weeklyPlanArea" style="white-space:pre-line;font-family:monospace;min-height:140px"></div>
      <p class="note">(Displays what admin sets. Can add special plans in Settings.)</p>
    </section>

    <section class="card" id="newRequestCard" style="margin-top:12px">
      <h3>New Cleaning Request</h3>
      <div>
        <label>Message</label>
        <textarea id="requestMessage" rows="3" placeholder="Describe the issue..."></textarea>
      </div>
      <div style="margin-top:8px">
        <label>Upload up to 5 images (temporary)</label>
        <input id="requestImages" type="file" accept="image/*" multiple />
        <div id="previewArea" style="display:flex;gap:8px;margin-top:8px"></div>
      </div>
      <div style="margin-top:10px">
        <button id="btnCreateRequest">Submit Request</button>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <h3>Requests</h3>
      <div id="requestsList" class="requests-list"></div>
    </section>

  </main>

  <aside>
    <div class="card">
      <h4>Consumables Inventory</h4>
      <div id="consumablesList"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Cleaning Products Inventory</h4>
      <div id="productsList"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Quick Actions</h4>
      <button id="btnRefresh" class="small">Refresh</button>
      <p class="note" style="margin-top:8px">Anyone can view inventory. Input (in/out) requires admin/supervisor password.</p>
    </div>
  </aside>
</div>

<!-- Modals -->
<div id="modalRoot"></div>

<!-- Firebase SDKs -->
<script type="module">
/* ===========================
   Put firebase config here (you supplied it in your message)
   ===========================
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update, get, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

// ====== YOUR firebaseConfig (from your message) ======
const firebaseConfig = {
  apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
  authDomain: "rtu-system-han.firebaseapp.com",
  databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
  projectId: "rtu-system-han",
  storageBucket: "rtu-system-han.firebasestorage.app",
  messagingSenderId: "960060003353",
  appId: "1:960060003353:web:25be936a3d3ebea8b0c688",
  measurementId: "G-D0KT7KEC1H"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

/* ============ Utilities ============ */
const $ = id => document.getElementById(id);

function el(tag, props={}, ...children){
  const e = document.createElement(tag);
  Object.assign(e, props);
  for(const c of children){
    if (typeof c === 'string') e.appendChild(document.createTextNode(c));
    else if (c) e.appendChild(c);
  }
  return e;
}

// SHA-256 hashing utility for password compare (browser)
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ========== Initial default settings (if DB empty) ========== */
async function ensureDefaults(){
  const root = ref(db, '/settings');
  const snap = await get(child(ref(db), 'settings'));
  if(!snap.exists()){
    // default demo passwords: admin: admin123, supervisor: sup123
    const adminHash = await sha256Hex('admin123');
    const supHash = await sha256Hex('sup123');
    await set(ref(db,'settings'), {
      weeklyPlan: "Mon: \nTue: \nWed: \nThu: \nFri: \nSat: \nSun: \n\nSpecial:",
      passwords: { admin: adminHash, supervisor: supHash },
      consumablesItems: {
        toilet_paper: {label:"Toilet Paper", qty:50, reorderLevel:20},
        soap: {label:"Soap", qty:30, reorderLevel:10},
        paper_towels: {label:"Paper Towels", qty:40, reorderLevel:15},
        trash_large: {label:"Large Trash Bags", qty:25, reorderLevel:10},
        trash_small: {label:"Small Trash Bags", qty:60, reorderLevel:20}
      },
      productsItems: {
        nabc:{label:"NABC", qty:10, reorderLevel:5},
        bleach:{label:"Bleach", qty:8, reorderLevel:4},
        xcelente:{label:"Xcelente", qty:6, reorderLevel:3},
        ecolyzer:{label:"Eco-Lyzer", qty:7, reorderLevel:3},
        fast_easy:{label:"Fast & Easy", qty:9, reorderLevel:4},
        wipes:{label:"Wipes", qty:20, reorderLevel:8},
        gloves_m:{label:"Gloves M", qty:50, reorderLevel:20},
        pine_sol:{label:"Pine-sol", qty:6, reorderLevel:3},
        brown_bag:{label:"Brown bag", qty:30, reorderLevel:10}
      }
    });
  }
}

/* ============ Render functions ============ */

function renderWeekly(planText){
  $('weeklyPlanArea').textContent = planText || "(No weekly plan set)";
}

function renderInventory(itemsObj, containerId, type){
  const container = $(containerId);
  container.innerHTML = '';
  for(const key of Object.keys(itemsObj || {})){
    const it = itemsObj[key];
    const row = el('div',{className:'inventory-row'});
    const left = el('div',{}, el('div',{style:'font-weight:700'}, it.label), el('div',{className:'note'}, `Qty: ${it.qty}  |  Reorder at: ${it.reorderLevel}`));
    const right = el('div',{}, 
      el('button',{className:'small',onclick:()=>openInOutModal(type,key,it)}, 'In/Out'),
      (it.qty <= it.reorderLevel) ? el('div',{style:'marginTop:6px'}, el('span',{className:'warn'}, 'REORDER NEEDED')) : null
    );
    row.appendChild(left); row.appendChild(right);
    container.appendChild(row);
  }
}

/* ============ Modals ============ */
function showModal(htmlContent){
  const root = $('modalRoot');
  root.innerHTML = '';
  const modal = el('div',{className:'modal'});
  const content = el('div',{className:'modal-content'}, htmlContent);
  modal.appendChild(content);
  modal.addEventListener('click', (e)=>{ if(e.target===modal){ root.innerHTML=''; } });
  root.appendChild(modal);
  return root;
}

function closeModal(){ $('modalRoot').innerHTML=''; }

/* ============ Auth-like check (admin/supervisor) ============ */
async function promptPasswordAndCheck(){
  return new Promise(async (resolve)=>{
    const cont = el('div',{},
      el('h3',{},'Enter Admin or Supervisor Password'),
      el('div',{}, el('input',{id:'pwdInput',placeholder:'password',type:'password'})),
      el('div',{style:'marginTop:8px;display:flex;gap:8px;justify-content:flex-end'},
         el('button',{onclick:async ()=>{
           const val = document.getElementById('pwdInput').value || '';
           const providedHash = await sha256Hex(val);
           const snap = await get(child(ref(db), 'settings/passwords'));
           const pwObj = snap.val() || {};
           const okAdmin = pwObj.admin === providedHash;
           const okSup = pwObj.supervisor === providedHash;
           if(okAdmin) { closeModal(); resolve({role:'admin'}); }
           else if(okSup){ closeModal(); resolve({role:'supervisor'}); }
           else { alert('Password incorrect'); }
         }}, 'Confirm'),
         el('button',{onclick:()=>{ closeModal(); resolve(null); }}, 'Cancel')
      )
    );
    showModal(cont);
  });
}

/* ============ Open in/out modal ============ */
async function openInOutModal(type,key,item){
  // ask password first
  const auth = await promptPasswordAndCheck();
  if(!auth){ return; }
  const cont = el('div',{},
    el('h3',{},`Inventory: ${item.label}`),
    el('div',{},el('label',{},'Action'), el('select',{id:'ioAction'}, el('option',{value:'in'},'IN'), el('option',{value:'out'},'OUT'))),
    el('div',{},el('label',{},'Quantity'), el('input',{id:'ioQty',type:'number',min:1,placeholder:'1'})),
    el('div',{style:'marginTop:8px;display:flex;gap:8px;justify-content:flex-end'},
      el('button',{onclick:async ()=>{
        const action = document.getElementById('ioAction').value;
        const qty = Number(document.getElementById('ioQty').value) || 0;
        if(qty<=0){ alert('Enter valid qty'); return; }
        const itemPath = (type==='consumables')?`settings/consumablesItems/${key}`:`settings/productsItems/${key}`;
        // transactional update
        const itemRef = child(ref(db), itemPath);
        const snap = await get(itemRef);
        if(!snap.exists()){ alert('Item missing'); return; }
        const cur = snap.val();
        const newQty = (action==='in')? cur.qty + qty : cur.qty - qty;
        await update(itemRef, { qty: newQty });
        // add log
        await push(ref(db,'logs'), { itemKey:key, itemLabel:cur.label, type, action, qty, by:auth.role, ts: Date.now() });
        closeModal();
      }}, 'Save'),
      el('button',{onclick:()=>closeModal()}, 'Cancel')
    )
  );
  showModal(cont);
}

/* ============ Requests handling ============ */
let currentUploadFiles = [];

$('requestImages').addEventListener('change', (ev)=>{
  const fl = Array.from(ev.target.files).slice(0,5);
  currentUploadFiles = fl;
  const preview = $('previewArea'); preview.innerHTML='';
  fl.forEach(f=>{
    const img = document.createElement('img');
    img.className='img-thumb';
    img.src = URL.createObjectURL(f);
    img.title = f.name;
    img.addEventListener('click', ()=> showImageModal(img.src));
    preview.appendChild(img);
  });
});

function showImageModal(src){
  const content = el('div',{},
    el('img',{src, style:'max-width:100%;max-height:70vh;border-radius:6px'}),
    el('div',{style:'text-align:right;marginTop:8px'}, el('button',{onclick:()=>closeModal()}, 'Close'))
  );
  showModal(content);
}

$('btnCreateRequest').addEventListener('click', async ()=>{
  const msg = $('requestMessage').value.trim();
  const idRef = push(ref(db,'requests'));
  const id = idRef.key;
  // upload images to storage temporarily
  const imgUrls = [];
  for(let i=0;i<currentUploadFiles.length && i<5;i++){
    const f = currentUploadFiles[i];
    const path = `requests/${id}/${Date.now()}_${f.name}`;
    const stRef = sref(storage, path);
    const up = await uploadBytes(stRef, f);
    const url = await getDownloadURL(stRef);
    imgUrls.push({path, url});
  }
  await set(idRef, {
    message: msg,
    images: imgUrls,
    status: 'New',
    createdAt: Date.now()
  });
  // reset UI
  $('requestMessage').value=''; $('requestImages').value=''; $('previewArea').innerHTML=''; currentUploadFiles=[];
  alert('Request submitted');
});

/* ========= Render live DB data ========= */
async function bindRealtime(){
  // ensure defaults
  await ensureDefaults();

  // weekly plan
  onValue(ref(db,'settings/weeklyPlan'), snap=>{
    renderWeekly(snap.val());
  });

  // settings items
  onValue(ref(db,'settings/consumablesItems'), snap=>{
    renderInventory(snap.val(), 'consumablesList', 'consumables');
  });
  onValue(ref(db,'settings/productsItems'), snap=>{
    renderInventory(snap.val(), 'productsList', 'products');
  });

  // requests
  onValue(ref(db,'requests'), snap=>{
    const list = $('requestsList');
    list.innerHTML = '';
    const data = snap.val() || {};
    const keys = Object.keys(data).reverse();
    keys.forEach(k=>{
      const r = data[k];
      const card = el('div',{style:'padding:8px;border-bottom:1px solid #eee'});
      card.appendChild(el('div',{style:'font-weight:700'}, r.message || '(no message)'));
      if(r.images && r.images.length){
        const wrap = el('div',{style:'display:flex;gap:6px;marginTop:6px'});
        r.images.forEach(im => {
          const img = el('img',{src:im.url,className:'img-thumb',onclick:()=>showImageModal(im.url)});
          wrap.appendChild(img);
        });
        card.appendChild(wrap);
      }
      const status = el('div',{style:'marginTop:8px'}, el('span',{}, `Status: ${r.status || 'New'}`));
      card.appendChild(status);
      const actions = el('div',{style:'marginTop:8px;display:flex;gap:8px;justify-content:flex-end'});
      // Anyone can accept -> mark In Progress (but requires admin/sup)
      const btnAccept = el('button',{onclick:async ()=>{
        const auth = await promptPasswordAndCheck();
        if(!auth) return;
        await update(ref(db,`requests/${k}`), { status:'In Progress', assignedBy:auth.role, assignedAt: Date.now() });
      }}, 'Accept (In Progress)');
      const btnComplete = el('button',{onclick:async ()=>{
        const auth = await promptPasswordAndCheck();
        if(!auth) return;
        // allow completion only by admin/supervisor — our prompt enforces that already
        // allow upload of completion images
        showCompletionUploader(k);
      }, className:'small'}, 'Complete (upload photos)');
      const btnDelete = el('button',{onclick:async ()=>{
        // delete images in storage then remove request
        if(!confirm('Delete request and images?')) return;
        const rSnap = (await get(child(ref(db),`requests/${k}`))).val();
        if(rSnap && rSnap.images){
          for(const im of (rSnap.images||[])){
            try{ await deleteObject(sref(storage, im.path)); }catch(e){}
          }
        }
        await set(ref(db,`requests/${k}`), null);
      }, className:'small'}, 'Delete');
      actions.appendChild(btnAccept); actions.appendChild(btnComplete); actions.appendChild(btnDelete);
      card.appendChild(actions);
      list.appendChild(card);
    });
  });
}

// completion uploader
function showCompletionUploader(requestId){
  const input = el('input',{type:'file',multiple:true,accept:'image/*'});
  const content = el('div',{},
    el('h3',{},'Upload completion photos (up to 5)'),
    input,
    el('div',{style:'marginTop:8px;display:flex;justify-content:flex-end'},
      el('button',{onclick:async ()=>{
        const fl = Array.from(input.files).slice(0,5);
        const urls = [];
        for(const f of fl){
          const path = `requests/${requestId}/complete/${Date.now()}_${f.name}`;
          const st = sref(storage, path);
          await uploadBytes(st, f);
          const url = await getDownloadURL(st);
          urls.push({path,url});
        }
        await update(ref(db,`requests/${requestId}`), { status:'Completed', completedAt: Date.now(), completionImages:urls });
        // remove original images (they were temporary)
        const rSnap = await get(child(ref(db), `requests/${requestId}`));
        const r = rSnap.val();
        if(r && r.images){
          for(const im of r.images){ try{ await deleteObject(sref(storage, im.path)); }catch(e){} }
          await update(ref(db,`requests/${requestId}`), { images: null });
        }
        closeModal();
      }}, 'Upload & Mark Complete'),
      el('button',{onclick:()=>closeModal()}, 'Cancel')
    )
  );
  showModal(content);
}

/* ============ Settings UI ============ */
$('btn-settings').addEventListener('click', async ()=>{
  const auth = await promptPasswordAndCheck();
  // Only admin should open settings to change passwords — but viewing settings could be open to admin/supervisor. 
  if(!auth){ return; }
  // load settings snapshot
  const snap = await get(ref(db,'settings'));
  const s = snap.val() || {};
  const weekly = s.weeklyPlan || '';
  const passwords = s.passwords || {};
  const consumables = s.consumablesItems || {};
  const products = s.productsItems || {};

  const weeklyArea = el('textarea',{id:'settingsWeekly',rows:10,style:'width:100%'}); weeklyArea.value = weekly;

  // build list editors for items
  function itemsEditor(obj, idPrefix){
    const frag = el('div',{});
    for(const k of Object.keys(obj||{})){
      const it = obj[k];
      const row = el('div',{style:'display:flex;gap:8px;margin-bottom:6px'},
        el('input',{value:k,disabled:true,style:'width:30%'}),
        el('input',{value:it.label,style:'width:40%'}),
        el('input',{type:'number',value:it.qty,style:'width:15%'}),
        el('input',{type:'number',value:it.reorderLevel,style:'width:15%'}),
        el('button',{onclick:async ()=>{
          // remove
          if(!confirm('Delete item?')) return;
          await update(ref(db,'settings'), {}); // just to ensure write availability
          await set(ref(db,`settings/${idPrefix}/${k}`), null);
          closeModal(); // force refresh
        }}, 'Del')
      );
      frag.appendChild(row);
    }
    return frag;
  }

  const content = el('div',{},
    el('h3',{},'Settings'),
    el('div',{}, el('label',{},'Weekly Cleaning Plan'), weeklyArea),
    el('h4',{},'Consumables Items'),
    itemsEditor(consumables,'consumablesItems'),
    el('p',{className:'note'}, 'To add or edit items, use the DB directly or extend this UI.'),
    el('h4',{},'Cleaning Products Items'),
    itemsEditor(products,'productsItems'),
    el('h4',{},'Change Passwords (Admin only)'),
    el('p',{}, el('label',{},'New Admin Password'), el('input',{id:'newAdminPass',type:'password'})),
    el('p',{}, el('label',{},'New Supervisor Password'), el('input',{id:'newSupPass',type:'password'})),
    el('div',{style:'margin-top:8px;display:flex;justify-content:flex-end;gap:8px'},
      el('button',{onclick:async ()=>{
        // save weekly + optional password changes
        const newWeekly = document.getElementById('settingsWeekly').value;
        await update(ref(db,'settings'), { weeklyPlan: newWeekly });
        const na = document.getElementById('newAdminPass').value.trim();
        const ns = document.getElementById('newSupPass').value.trim();
        if(na){
          const h = await sha256Hex(na);
          await update(ref(db,'settings/passwords'), { admin: h });
        }
        if(ns){
          const h2 = await sha256Hex(ns);
          await update(ref(db,'settings/passwords'), { supervisor: h2 });
        }
        alert('Settings saved');
        closeModal();
      }}, 'Save'),
      el('button',{onclick:()=>closeModal()}, 'Cancel')
    )
  );
  showModal(content);
});

/* ============ Reports ============ */
$('btn-report').addEventListener('click', async ()=>{
  // simple report builder: choose date range then fetch logs
  const content = el('div',{},
    el('h3',{},'Reports - Inventory Logs'),
    el('div',{}, el('label',{},'From (timestamp)'), el('input',{id:'rFrom',type:'date'})),
    el('div',{}, el('label',{},'To (timestamp)'), el('input',{id:'rTo',type:'date'})),
    el('div',{style:'margin-top:8px;display:flex;justify-content:flex-end;gap:8px'},
      el('button',{onclick:async ()=>{
        const f = document.getElementById('rFrom').value;
        const t = document.getElementById('rTo').value;
        const fromTs = f ? new Date(f).getTime() : 0;
        const toTs = t ? new Date(t).getTime() + 24*3600*1000 -1 : Date.now();
        const snap = await get(ref(db,'logs'));
        const logs = snap.val() || {};
        const rows = [];
        for(const k of Object.keys(logs)){
          const L = logs[k];
          if(L.ts >= fromTs && L.ts <= toTs) rows.push(L);
        }
        // show and export
        const table = el('div',{}, el('h4',{},`Found ${rows.length} logs`));
        const ttxt = rows.map(r=>`${new Date(r.ts).toLocaleString()},${r.itemLabel},${r.action},${r.qty},${r.by}`).join('\n');
        const exportBtn = el('button',{onclick:()=>{
          const csv = 'Date,Item,Action,Qty,By\n' + ttxt;
          const blob = new Blob([csv], {type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download = 'inventory_logs.csv'; a.click();
        }}, 'Export CSV');
        const printBtn = el('button',{onclick:()=>{ window.print(); }}, 'Print');
        table.appendChild(exportBtn); table.appendChild(printBtn);
        const list = el('div',{style:'max-height:300px;overflow:auto;marginTop:8px'});
        rows.forEach(r=>{
          list.appendChild(el('div',{}, `${new Date(r.ts).toLocaleString()} | ${r.itemLabel} | ${r.action} ${r.qty} | by: ${r.by}`));
        });
        const rootc = showModal(el('div',{}, table, list, el('div',{style:'marginTop:8px;display:flex;justify-content:flex-end'}, el('button',{onclick:()=>closeModal()}, 'Close'))));
      }}, 'Generate'),
      el('button',{onclick:()=>closeModal()}, 'Close')
    )
  );
  showModal(content);
});

/* ============ Init ============ */
(async function(){
  await bindRealtime();
})();

</script>
</body>
</html>
