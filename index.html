<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITAC ì²­ì†Œê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 4px solid #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center py-6 bg-white shadow-lg rounded-xl mb-6">
            <h1 class="text-4xl font-extrabold text-blue-700 tracking-tight">ITAC ì²­ì†Œ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p id="auth-status" class="mt-2 text-sm text-gray-500">
                <span id="loading-spinner" class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent mr-2"></span>
                ì´ˆê¸°í™” ì¤‘...
            </p>
        </header>

        <nav class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-0 z-10">
            <button class="tab-button active px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('home')">ë©”ì¸</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('requests')">ì²­ì†Œ ìš”ì²­</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('reports')">ì¬ê³  ë³´ê³ ì„œ</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('settings')">ì„¤ì •</button>
        </nav>

        <main id="main-content" class="min-h-[500px]">
            </main>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100 duration-300">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</h3>
            <p class="text-sm text-gray-600 mb-4" id="modal-role-info">ì•¡ì…˜ì„ ì§„í–‰í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <div class="flex justify-end space-x-3">
                <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" onclick="closePasswordModal()">ì·¨ì†Œ</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="submitPassword()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="io-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-100 duration-300">
            <h3 class="text-2xl font-bold mb-4 text-gray-800" id="io-modal-title">ì¬ê³  ì…/ì¶œê³ </h3>
            <p class="text-gray-600 mb-4">í˜„ì¬ í•­ëª©: <span id="io-item-name" class="font-semibold text-blue-600"></span></p>

            <div class="mb-4">
                <label for="io-type" class="block text-sm font-medium text-gray-700 mb-1">êµ¬ë¶„</label>
                <select id="io-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="in">ì…ê³ </option>
                    <option value="out">ì¶œê³ </option>
                </select>
            </div>
            <div class="mb-4">
                <label for="io-quantity" class="block text-sm font-medium text-gray-700 mb-1">ìˆ˜ëŸ‰</label>
                <input type="number" id="io-quantity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" min="1">
            </div>
            <div class="mb-6">
                <label for="io-memo" class="block text-sm font-medium text-gray-700 mb-1">ë©”ëª¨ (ì„ íƒ)</label>
                <input type="text" id="io-memo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ê°„ë‹¨í•œ ë©”ëª¨">
            </div>

            <div class="flex justify-end space-x-3">
                <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" onclick="closeIOModal()">ì·¨ì†Œ</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="performInventoryAction()">ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="fixed bottom-4 right-4 z-50"></div>

    <script type="module">
        // Import Firebase SDKs (v11.6.1 for stability with the code structure)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs, updateDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAdmin = false;
        window.isSupervisor = false;
        
        // --- Firebase Initialization and Auth ---

        // ğŸš¨ğŸš¨ğŸš¨ ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì • ì •ë³´ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
        const firebaseConfig = {
            apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
            authDomain: "rtu-system-han.firebaseapp.com",
            databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
            projectId: "rtu-system-han",
            storageBucket: "rtu-system-han.firebasestorage.app",
            messagingSenderId: "960060003353",
            appId: "1:960060003353:web:25be936a3d3ebea8b0c688",
            measurementId: "G-D0KT7KEC1H"
        };
        
        // í”„ë¡œì íŠ¸ IDë¥¼ ì•±ì˜ ê³ ìœ  IDë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const appId = firebaseConfig.projectId; 
        // ìµëª… ë¡œê·¸ì¸ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì´ˆê¸° ì¸ì¦ í† í°ì€ nullì…ë‹ˆë‹¤.
        const initialAuthToken = null; 
        
        // ğŸš¨ğŸš¨ğŸš¨ END OF FIREBASE CONFIGURATION ğŸš¨ğŸš¨ğŸš¨


        // Application State
        window.state = {
            currentView: 'home',
            settings: {
                weeklyPlan: Array(10).fill({ day: 'ì›”ìš”ì¼', task: '' }),
                safetyStock: {},
                consumables: [
                    { id: 'toilet_paper', name: 'í™”ì¥ì‹¤ íœ´ì§€', category: 'consumable', reorderLevel: 50 },
                    { id: 'liquid_soap', name: 'ë¬¼ë¹„ëˆ„', category: 'consumable', reorderLevel: 20 },
                    { id: 'paper_towel', name: 'í˜ì´í¼ íƒ€ì›”', category: 'consumable', reorderLevel: 30 },
                    { id: 'trash_bag_l', name: 'ê²€ì • ì“°ë ˆê¸° ë´‰íˆ¬(ëŒ€)', category: 'consumable', reorderLevel: 10 },
                    { id: 'trash_bag_s', name: 'ì“°ë ˆê¸°í†µ ë´‰íˆ¬(ì†Œ)', category: 'consumable', reorderLevel: 10 },
                ],
                supplies: [
                    { id: 'nabc', name: 'NABC', category: 'supply', reorderLevel: 5 },
                    { id: 'bleach', name: 'Bleach', category: 'supply', reorderLevel: 3 },
                    { id: 'xcelente', name: 'Xcelente', category: 'supply', reorderLevel: 4 },
                    { id: 'eco_lyzer', name: 'Eco-Lyzer', category: 'supply', reorderLevel: 4 },
                    { id: 'fast_easy', name: 'Fast & easy', category: 'supply', reorderLevel: 5 },
                    { id: 'wipes', name: 'Wipes', category: 'supply', reorderLevel: 10 },
                    { id: 'gloves_m', name: 'Gloves M', category: 'supply', reorderLevel: 10 },
                    { id: 'pine_sol', name: 'Pine-sol', category: 'supply', reorderLevel: 5 },
                    { id: 'brown_bag', name: 'brown bag', category: 'supply', reorderLevel: 10 },
                ],
                // ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ê´€ë¦¬ì/ìˆ˜í¼ë°”ì´ì € ë¹„ë°€ë²ˆí˜¸ë¥¼ 0000/1111ë¡œ ë³€ê²½
                passwords: { admin: '0000', supervisor: '1111' } // Initial default passwords as requested by user
            },
            inventory: {}, // Current stock calculated from logs
            requests: [], // List of cleaning requests
            inventoryLogs: [], // All inventory logs
            isAuthReady: false,
            passwordCallback: null,
            passwordRole: null,
            inventoryActionContext: null,
        };

        /**
         * Converts base64 image data (simulated) to a URL for display.
         */
        window.toImageUrl = (base64) => base64 ? `data:image/png;base64,${base64}` : 'https://placehold.co/100x100/f3f4f6/9ca3af?text=No+Image';

        /**
         * Global function to display a temporary message. (Localized to English)
         */
        // [FIX 2] ë©”ì‹œì§€ê°€ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ë¡œì§ ìˆ˜ì • (ìœ ì§€)
        window.showMessage = (message, type = 'success') => {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            let icon = 'check-circle';

            if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = 'alert-triangle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                icon = 'info';
            }

            // [FIX 2] animate-in í´ë˜ìŠ¤ëŠ” ê·¸ëŒ€ë¡œ ë‘ì–´ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹œë„í•˜ì§€ë§Œ, ì œê±° ë¡œì§ì€ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            const messageHtml = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl mb-3 flex items-center transform transition-all duration-300">
                    <i data-lucide="${icon}" class="w-5 h-5 mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            box.insertAdjacentHTML('beforeend', messageHtml);
            lucide.createIcons();

            const latestMessage = box.lastElementChild;
            
            // 3ì´ˆ í›„ í˜ì´ë“œ ì•„ì›ƒ ì‹œì‘
            setTimeout(() => {
                // í˜ì´ë“œ ì•„ì›ƒ íš¨ê³¼ë¥¼ ìœ„í•œ CSS ì†ì„± ì ìš©
                latestMessage.style.transition = 'opacity 0.5s ease-in-out';
                latestMessage.style.opacity = '0';
                
                // 0.5ì´ˆ í›„ ì™„ì „íˆ ì œê±°
                setTimeout(() => {
                    latestMessage.remove();
                }, 500);
            }, 3000); // 3.0ì´ˆ ëŒ€ê¸°
        };

        /**
         * Initializes Firebase and sets up authentication/listeners. (Localized to English)
         */
        window.setupFirebase = async () => {
            try {
                // Set Firestore logging to Debug for visibility in console
                setLogLevel('Debug');
                
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Auth state listener
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('auth-status').innerHTML = `
                            ì‚¬ìš©ì ID: <span class="font-mono text-xs p-1 bg-gray-100 rounded">${window.userId}</span> |
                            <span class="text-green-600">ì¸ì¦ë¨</span>
                        `;
                        // Start listening to data only after successful authentication
                        window.state.isAuthReady = true;
                        window.setupDataListeners();
                        window.render();
                    } else {
                        document.getElementById('auth-status').innerHTML = `<span class="text-red-600">ì¸ì¦ ì‹¤íŒ¨</span>`;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                window.showMessage(`Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Helper function to get a reference to a document in the public data path.
         * The path structure is: artifacts/{appId}/public/data/{collectionName}/{documentId}
         */
        const getPublicConfigDocRef = (collectionName, documentId = 'config') => {
             // 4 segment document ref: artifacts/{appId}/public/data
            const publicRootDocRef = doc(window.db, 'artifacts', appId, 'public', 'data');
            // 5 segment collection ref: artifacts/{appId}/public/data/{collectionName}
            const collectionRef = collection(publicRootDocRef, collectionName);
            // 6 segment document ref: artifacts/{appId}/public/data/{collectionName}/{documentId}
            return doc(collectionRef, documentId);
        }

        /**
         * Helper function to get a reference to a public collection (5 segments).
         */
        const getPublicCollectionRef = (collectionName) => {
             // 4 segment document ref: artifacts/{appId}/public/data
            const publicRootDocRef = doc(window.db, 'artifacts', appId, 'public', 'data');
            // 5 segment collection ref: artifacts/{appId}/public/data/{collectionName}
            return collection(publicRootDocRef, collectionName);
        }

        /**
         * Sets up real-time listeners for all necessary data.
         */
        window.setupDataListeners = () => {
            if (!window.state.isAuthReady || !window.db) return;

            const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
            
            // 1. Settings (Admin's Private Data for Passwords/Master Lists)
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.state.settings.passwords = data.passwords || window.state.settings.passwords;
                    window.state.settings.consumables = data.consumables || window.state.settings.consumables;
                    window.state.settings.supplies = data.supplies || data.supplies;
                } else {
                    // Initialize settings if it's the first run for this user
                    // This sets initial passwords and inventory lists.
                    setDoc(userDocRef, {
                        passwords: window.state.settings.passwords,
                        consumables: window.state.settings.consumables,
                        supplies: window.state.settings.supplies,
                    }, { merge: true });
                }
            });

            // 2. Weekly Plan (Public Data - Config document in the collection)
            const planDocRef = getPublicConfigDocRef('itac_plan');
            onSnapshot(planDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.state.settings.weeklyPlan = docSnap.data().weeklyPlan || window.state.settings.weeklyPlan;
                } else {
                    setDoc(planDocRef, { weeklyPlan: window.state.settings.weeklyPlan });
                }
                window.render();
            });
            
            // 3. Safety Stock Levels (Public Data - Config document in the collection)
            const safetyStockDocRef = getPublicConfigDocRef('itac_safety_stock');
            onSnapshot(safetyStockDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.state.settings.safetyStock = docSnap.data().levels || {};
                }
                window.render();
            });

            // 4. Inventory Logs (Private Data - Admin/Supervisor managed)
            onSnapshot(collection(userDocRef, 'itac_inventory_logs'), (snapshot) => {
                window.state.inventoryLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.calculateInventory(); // Recalculate stock and re-render
            });

            // 5. Cleaning Requests (Public Data - Collection)
            const requestsCollectionRef = getPublicCollectionRef('cleaning_requests');
            // NOTE: Firestore requires an index for orderBy. To avoid user-side indexing issues, 
            // the sorting is done in memory. (Removed `orderBy` from query).
            onSnapshot(requestsCollectionRef, (snapshot) => {
                window.state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); // Sort by timestamp DESC
                window.render();
            });

        };

        // --- Inventory Logic ---

        /**
         * Recalculates current inventory stock levels from the logs.
         */
        window.calculateInventory = () => {
            const stock = {};
            window.state.inventoryLogs.forEach(log => {
                stock[log.itemId] = stock[log.itemId] || 0;
                if (log.type === 'in') {
                    stock[log.itemId] += log.quantity;
                } else if (log.type === 'out') {
                    stock[log.itemId] -= log.quantity;
                }
            });
            window.state.inventory = stock;
            window.render();
        };

        // --- Authentication & Security Logic (Password Check) (Localized to English) ---

        /**
         * Checks user-entered password against Admin/Supervisor passwords.
         * @param {string} role 'admin' or 'supervisor'
         * @param {function} callback Function to execute on success
         */
        window.checkPassword = (role, callback) => {
            const modal = document.getElementById('password-modal');
            const title = document.getElementById('modal-title');
            const roleInfo = document.getElementById('modal-role-info');
            const confirmBtn = modal.querySelector('button:last-child');
            const cancelBtn = modal.querySelector('button:first-child');

            // Set state for the modal
            window.state.passwordCallback = callback;
            window.state.passwordRole = role;

            title.textContent = `${role === 'admin' ? 'ê´€ë¦¬ì' : 'ìˆ˜í¼ë°”ì´ì €'} ë¹„ë°€ë²ˆí˜¸ í™•ì¸`;
            roleInfo.textContent = `ì´ ì‘ì—…ì€ ${role === 'admin' ? 'ê´€ë¦¬ì' : 'ê´€ë¦¬ì ë˜ëŠ” ìˆ˜í¼ë°”ì´ì €'} ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.`;
            document.getElementById('password-input').value = '';
            
            confirmBtn.textContent = 'í™•ì¸';
            cancelBtn.textContent = 'ì·¨ì†Œ';
            document.getElementById('password-input').placeholder = 'ë¹„ë°€ë²ˆí˜¸ ì…ë ¥';
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.submitPassword = () => {
            const password = document.getElementById('password-input').value;
            const role = window.state.passwordRole;
            const passwords = window.state.settings.passwords;
            let success = false;
            
            // [FIX] closePasswordModal()ì´ window.state.passwordCallbackì„ nullë¡œ ë§Œë“¤ê¸° ì „ì— ì½œë°±ì„ ì €ì¥í•©ë‹ˆë‹¤.
            const storedCallback = window.state.passwordCallback; 

            if (role === 'admin' && password === passwords.admin) {
                success = true;
                window.isAdmin = true;
            } else if (role === 'supervisor' && (password === passwords.admin || password === passwords.supervisor)) {
                success = true;
                // Note: Admin also passes supervisor check
                window.isAdmin = (password === passwords.admin);
                window.isSupervisor = (password === passwords.supervisor);
            }

            closePasswordModal(); // ì´ í•¨ìˆ˜ëŠ” window.state.passwordCallbackì„ nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

            if (success && typeof storedCallback === 'function') { // ì €ì¥ëœ ì½œë°±ì´ í•¨ìˆ˜ì¸ì§€ í™•ì¸ í›„ ì‹¤í–‰
                storedCallback();
                window.showMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else if (!success) {
                window.showMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        };

        window.closePasswordModal = () => {
            document.getElementById('password-modal').classList.remove('flex');
            document.getElementById('password-modal').classList.add('hidden');
            window.state.passwordCallback = null;
            window.state.passwordRole = null;
            window.isAdmin = false;
            window.isSupervisor = false;
        };

        // --- UI Rendering ---

        /**
         * Changes the active view and re-renders.
         */
        window.changeView = (view) => {
            window.state.currentView = view;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="changeView('${view}')"]`).classList.add('active');
            window.render();
        };
        
        /**
         * Main rendering function based on current state.
         */
        window.render = () => {
            const content = document.getElementById('main-content');
            content.innerHTML = '';
            lucide.createIcons(); // Re-create lucide icons after injecting new HTML

            switch (window.state.currentView) {
                case 'home':
                    content.innerHTML = window.renderHome();
                    break;
                case 'requests':
                    content.innerHTML = window.renderRequests();
                    break;
                case 'settings':
                    content.innerHTML = window.renderSettings();
                    break;
                case 'reports':
                    content.innerHTML = window.renderReports();
                    break;
                default:
                    content.innerHTML = window.renderHome();
            }

            // Re-initialize icons
            lucide.createIcons();
        };

        // --- View Renderers (Mostly Localized to English) ---

        window.renderHome = () => {
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];
            const reorderAlerts = allItems.filter(item => {
                const currentStock = window.state.inventory[item.id] || 0;
                const reorderLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                return currentStock <= reorderLevel;
            });
            
            const weeklyPlanRows = window.state.settings.weeklyPlan.map((plan, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium text-gray-900">${plan.day || 'N/A'}</td>
                    <td class="p-3 text-gray-700">${plan.task || 'ê³„íš ì—†ìŒ'}</td>
                </tr>
            `).join('');

            const inventoryHtml = (items, title) => `
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">${title}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${items.map(item => {
                        const currentStock = window.state.inventory[item.id] || 0;
                        const reorderLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                        const isAlert = currentStock <= reorderLevel;
                        return `
                            <div class="bg-white p-5 rounded-xl shadow-lg border ${isAlert ? 'border-red-500 ring-4 ring-red-100' : 'border-gray-200'} cursor-pointer hover:shadow-xl transition" onclick="openIOModal('${item.id}', '${item.name}')">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                                    ${isAlert ? '<i data-lucide="bell-ring" class="w-6 h-6 text-red-500 animate-pulse"></i>' : ''}
                                </div>
                                <p class="text-sm text-gray-600">í˜„ì¬ ì¬ê³ : <span class="text-2xl font-extrabold ${isAlert ? 'text-red-600' : 'text-blue-600'}">${currentStock}</span> ê°œ</p>
                                <p class="text-xs text-gray-500 mt-1">ì•ˆì „ ì¬ê³ : ${reorderLevel}</p>
                                ${isAlert ? '<p class="text-xs font-bold text-red-500 mt-2">ğŸš¨ ì¬ê³  ë¶€ì¡± ì•Œë¦¼</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4 flex items-center">
                        <i data-lucide="calendar" class="w-7 h-7 mr-2"></i>
                        ì£¼ê°„ ì²­ì†Œ ê³„íš
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/4">ìš”ì¼/ë¶„ë¥˜</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-3/4">ê³„íš ìƒì„¸</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${weeklyPlanRows}
                            </tbody>
                        </table>
                    </div>
                </div>

                ${reorderAlerts.length > 0 ? `
                    <div class="bg-red-50 p-5 rounded-xl border border-red-300 shadow-md mb-6">
                        <h2 class="text-2xl font-bold text-red-600 mb-3 flex items-center">
                            <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                            ê¸´ê¸‰ ì¬ê³  ë¶€ì¡± ì•Œë¦¼
                        </h2>
                        <ul class="list-disc list-inside text-red-700 space-y-1">
                            ${reorderAlerts.map(item => `
                                <li><strong>${item.name}</strong>: í˜„ì¬ ì¬ê³  ${window.state.inventory[item.id] || 0} (ì•ˆì „ ì¬ê³  ${window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel})</li>
                            `).join('')}
                        </ul>
                    </div>
                ` : `<div class="bg-green-50 p-4 rounded-xl shadow-md mb-6 text-green-700 font-medium flex items-center">
                    <i data-lucide="thumbs-up" class="w-5 h-5 mr-2"></i>
                    ëª¨ë“  ì¬ê³  ìˆ˜ì¤€ì´ ì¶©ë¶„í•©ë‹ˆë‹¤.
                </div>`}

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        ${inventoryHtml(window.state.settings.consumables, 'ì†Œëª¨í’ˆ ì¬ê³  í˜„í™© (ì…/ì¶œê³ ë¥¼ ìœ„í•´ í•­ëª© í´ë¦­)')}
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        ${inventoryHtml(window.state.settings.supplies, 'ì²­ì†Œ ìš©í’ˆ ì¬ê³  í˜„í™© (ì…/ì¶œê³ ë¥¼ ìœ„í•´ í•­ëª© í´ë¦­)')}
                    </div>
                </div>
            `;
        };

        window.renderRequests = () => {
            const requestsHtml = window.state.requests.length > 0 ? window.state.requests.map(req => `
                <div class="bg-white p-5 rounded-xl shadow-md border ${req.status === 'ì™„ë£Œ' ? 'border-green-300' : req.status === 'ì‘ì—…ì¤‘' ? 'border-blue-300' : 'border-gray-300'}">
                    <div class="flex justify-between items-start mb-3 border-b pb-3">
                        <span class="text-sm text-gray-500">${new Date(req.timestamp.seconds * 1000).toLocaleString('ko-KR')}</span>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${req.status === 'ì™„ë£Œ' ? 'bg-green-100 text-green-800' : req.status === 'ì‘ì—…ì¤‘' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${req.status}</span>
                    </div>
                    <p class="text-lg font-semibold mb-3">ìš”ì²­ ë©”ì‹œì§€:</p>
                    <p class="text-gray-700 mb-4 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${req.requestMessage}</p>

                    <div class="mb-4">
                        <p class="text-md font-medium text-gray-700 mb-2">ìš”ì²­ ì‚¬ì§„:</p>
                        <div class="flex flex-wrap gap-2">
                            ${req.requestPhotos ? req.requestPhotos.map(p => `<img src="${window.toImageUrl(p)}" class="w-20 h-20 object-cover rounded-md shadow" onerror="this.src='https://placehold.co/80x80/cccccc/333333?text=Load+Error';">`).join('') : '<p class="text-sm text-gray-500">ì‚¬ì§„ ì—†ìŒ</p>'}
                        </div>
                    </div>

                    ${req.status === 'ì™„ë£Œ' ? `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <p class="text-lg font-semibold mb-3 text-green-600">ì™„ë£Œ ë³´ê³ ì„œ:</p>
                            <p class="text-gray-700 mb-4 p-3 bg-green-50 rounded-lg whitespace-pre-wrap">${req.completionMessage || 'ë©”ì‹œì§€ ì—†ìŒ'}</p>
                            <p class="text-md font-medium text-gray-700 mb-2">ì™„ë£Œ ì‚¬ì§„:</p>
                            <div class="flex flex-wrap gap-2">
                                ${req.completionPhotos ? req.completionPhotos.map(p => `<img src="${window.toImageUrl(p)}" class="w-20 h-20 object-cover rounded-md shadow" onerror="this.src='https://placehold.co/80x80/cccccc/333333?text=Load+Error';">`).join('') : '<p class="text-sm text-gray-500">ì‚¬ì§„ ì—†ìŒ</p>'}
                            </div>
                        </div>
                    ` : ''}

                    <div class="mt-4 pt-4 border-t border-gray-100 flex space-x-2">
                        ${req.status === 'ëŒ€ê¸°' ? `
                            <button class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-blue-600 transition" onclick="checkPassword('supervisor', () => updateRequestStatus('${req.id}', 'ì‘ì—…ì¤‘'))">ì‘ì—… ì¤‘ìœ¼ë¡œ ë³€ê²½</button>
                        ` : ''}
                        ${req.status === 'ì‘ì—…ì¤‘' ? `
                            <button class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-green-600 transition" onclick="openCompletionForm('${req.id}')">ì‘ì—… ì™„ë£Œ ë³´ê³ </button>
                        ` : ''}
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 text-lg py-10 bg-white rounded-xl shadow-md">í˜„ì¬ ê²Œì‹œëœ ì²­ì†Œ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-lg sticky top-[100px]">
                            <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                                <i data-lucide="plus-circle" class="w-6 h-6 mr-2"></i>
                                ìƒˆë¡œìš´ ì²­ì†Œ ìš”ì²­ (ì „ì²´ ì‚¬ìš©ì)
                            </h2>
                            <textarea id="request-message" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3" placeholder="ìƒì„¸ ìš”ì²­ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                            
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì§„ ì²¨ë¶€ (ìµœëŒ€ 5ê°œ, Base64 ì‹œë®¬ë ˆì´ì…˜)</label>
                            <input type="file" id="request-photo-input" accept="image/*" multiple max="5" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4" onchange="previewImages(this, 'request-preview')">
                            
                            <div id="request-preview" class="flex flex-wrap gap-2 mb-4"></div>

                            <button class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="submitCleaningRequest()">ìš”ì²­ ì œì¶œ</button>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-4" id="request-list-container">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                            <i data-lucide="list-ordered" class="w-6 h-6 mr-2"></i>
                            ì „ì²´ ìš”ì²­ ëª©ë¡
                        </h2>
                        ${requestsHtml}
                    </div>
                </div>
            `;
        };

        window.renderSettings = () => {
            const currentPasswords = window.state.settings.passwords;
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];

            const itemRows = (items) => items.map(item => `
                <li class="flex justify-between items-center p-3 border-b last:border-b-0 hover:bg-gray-50">
                    <span class="text-gray-700">${item.name} (ID: ${item.id})</span>
                    <button class="text-red-500 hover:text-red-700 p-1 rounded-full" onclick="deleteInventoryItem('${item.id}', '${item.category}')">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </li>
            `).join('');
            
            const safetyStockRows = allItems.map(item => {
                const currentLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                return `
                    <div class="flex items-center space-x-4 p-3 border-b hover:bg-gray-50">
                        <span class="w-1/3 text-gray-700 font-medium">${item.name}</span>
                        <input type="number" id="safety-stock-${item.id}" value="${currentLevel}" min="0" class="w-1/4 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-center">
                        <span class="text-sm text-gray-500">ê°œ (ì´ ìˆ˜ì¤€ ì´í•˜ë¡œ ë–¨ì–´ì§€ë©´ ì•Œë¦¼)</span>
                    </div>
                `;
            }).join('');


            return `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="key" class="w-6 h-6 mr-2"></i>
                            ê´€ë¦¬ì/ìˆ˜í¼ë°”ì´ì € ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label for="admin-pw" class="block text-sm font-medium text-gray-700">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (í˜„ì¬: ${currentPasswords.admin ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •'})</label>
                                <input type="password" id="admin-pw" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ìƒˆ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
                            </div>
                            <div>
                                <label for="supervisor-pw" class="block text-sm font-medium text-gray-700">ìˆ˜í¼ë°”ì´ì € ë¹„ë°€ë²ˆí˜¸ (í˜„ì¬: ${currentPasswords.supervisor ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •'})</label>
                                <input type="password" id="supervisor-pw" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="ìƒˆ ìˆ˜í¼ë°”ì´ì € ë¹„ë°€ë²ˆí˜¸">
                            </div>
                            <button class="bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updatePasswords)">ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (ê´€ë¦¬ì ì „ìš©)</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="calendar-plus" class="w-6 h-6 mr-2"></i>
                            ì£¼ê°„ ì²­ì†Œ ê³„íš ì„¤ì • (10ì¤„)
                        </h2>
                        <div id="weekly-plan-editor" class="space-y-3">
                            ${window.state.settings.weeklyPlan.map((plan, index) => `
                                <div class="flex space-x-3 items-center">
                                    <select id="plan-day-${index}" class="p-2 border border-gray-300 rounded-lg w-1/4">
                                        ${['ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼', 'ì¼ìš”ì¼', 'íŠ¹ì´ì‚¬í•­'].map(d => `<option value="${d}" ${plan.day === d ? 'selected' : ''}>${d}</option>`).join('')}
                                    </select>
                                    <input type="text" id="plan-task-${index}" value="${plan.task}" class="p-2 border border-gray-300 rounded-lg w-3/4" placeholder="ì²­ì†Œ ì‘ì—… ë‚´ìš©">
                                </div>
                            `).join('')}
                        </div>
                        <button class="mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updateWeeklyPlan)">ì£¼ê°„ ê³„íš ì €ì¥ (ê´€ë¦¬ì ì „ìš©)</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="shield" class="w-6 h-6 mr-2"></i>
                            ì•ˆì „ ì¬ê³ /ì¬ì£¼ë¬¸ ìˆ˜ëŸ‰ ì„¤ì •
                        </h2>
                        <div id="safety-stock-editor" class="space-y-2">
                            ${safetyStockRows}
                        </div>
                        <button class="mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updateSafetyStock)">ì•ˆì „ ì¬ê³  ì €ì¥ (ê´€ë¦¬ì ì „ìš©)</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="list-plus" class="w-6 h-6 mr-2"></i>
                            ì¬ê³  í•­ëª© ì¶”ê°€/ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)
                        </h2>
                        
                        <div class="flex space-x-4 mb-6">
                            <input type="text" id="new-item-name" class="p-3 border border-gray-300 rounded-lg w-1/3" placeholder="ìƒˆ í•­ëª© ì´ë¦„">
                            <select type="text" id="new-item-category" class="p-3 border border-gray-300 rounded-lg w-1/3">
                                <option value="consumable">ì†Œëª¨í’ˆ</option>
                                <option value="supply">ì²­ì†Œ ìš©í’ˆ</option>
                            </select>
                            <input type="number" id="new-item-reorder-level" class="p-3 border border-gray-300 rounded-lg w-1/6" placeholder="ê¸°ë³¸ ì¬ì£¼ë¬¸ ìˆ˜ëŸ‰" value="10" min="0">
                            <button class="bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition w-1/6" onclick="checkPassword('admin', addInventoryItem)">í•­ëª© ì¶”ê°€</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3">ì†Œëª¨í’ˆ ëª©ë¡</h3>
                                <ul class="divide-y divide-gray-200">
                                    ${itemRows(window.state.settings.consumables)}
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3">ì²­ì†Œ ìš©í’ˆ ëª©ë¡</h3>
                                <ul class="divide-y divide-gray-200">
                                    ${itemRows(window.state.settings.supplies)}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.renderReports = () => {
            const logs = window.state.inventoryLogs;
            
            // Function to filter and format logs
            const renderLogTable = (filteredLogs) => {
                if (filteredLogs.length === 0) {
                    return '<p class="text-center text-gray-500 py-6">ì„ íƒí•œ ê¸°ê°„ì— ëŒ€í•œ ì¬ê³  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

                return `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ë‚ ì§œ</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">í•­ëª©</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">êµ¬ë¶„</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">ìˆ˜ëŸ‰</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ë©”ëª¨</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredLogs.map(log => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 text-sm text-gray-900">${new Date(log.timestamp.seconds * 1000).toLocaleDateString('ko-KR')}</td>
                                        <td class="p-3 text-sm text-gray-700">${log.itemName}</td>
                                        <td class="p-3 text-sm font-medium ${log.type === 'in' ? 'text-blue-600' : 'text-red-600'}">${log.type === 'in' ? 'ì…ê³ ' : 'ì¶œê³ '}</td>
                                        <td class="p-3 text-right text-sm font-bold">${log.quantity}</td>
                                        <td class="p-3 text-sm text-gray-500">${log.memo || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-600 mb-6 flex items-center">
                        <i data-lucide="clipboard-list" class="w-7 h-7 mr-2"></i>
                        ì¬ê³  ê¸°ë¡ ë³´ê³ ì„œ
                    </h2>

                    <div class="flex flex-wrap items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6 p-4 border rounded-lg bg-gray-50">
                        <div class="flex-shrink-0 text-sm font-medium text-gray-700">ê¸°ê°„ ì„ íƒ:</div>
                        <input type="date" id="report-start-date" class="p-2 border border-gray-300 rounded-lg">
                        <span>~</span>
                        <input type="date" id="report-end-date" class="p-2 border border-gray-300 rounded-lg">
                        <button class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-800 transition text-sm" onclick="filterLogs()">í•„í„°ë§</button>
                        
                        <div class="sm:ml-auto flex space-x-2">
                            <button class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition text-sm" onclick="exportToExcel()">
                                <i data-lucide="file-text" class="w-5 h-5 inline-block mr-1"></i>
                                ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° (ì‹œë®¬ë ˆì´ì…˜)
                            </button>
                            <button class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition text-sm" onclick="window.print()">
                                <i data-lucide="printer" class="w-5 h-5 inline-block mr-1"></i>
                                ì¸ì‡„
                            </button>
                        </div>
                    </div>

                    <div id="report-table-container">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">ì „ì²´ ì¬ê³  ê¸°ë¡ (ìµœì‹ ìˆœ)</h3>
                        ${renderLogTable(logs)}
                    </div>
                </div>
            `;
        };

        // --- Core Action Functions ---

        /**
         * Cleans up file input and converts file data (simulated as Base64)
         */
        const processFile = (fileInput) => {
            const files = Array.from(fileInput.files).slice(0, 5); // Max 5 files
            const base64Photos = [];
            
            files.forEach(file => {
                // Simplified Base64 conversion for demonstration, as actual FileReader is asynchronous
                // and complex to manage in a single-function structure.
                // For now, we simulate.
                base64Photos.push(`DEMO_BASE64_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            });
            return base64Photos;
        };
        
        /**
         * Cleans up file input and converts file data (actual Base64 conversion for simple files).
         * NOTE: This simplified version will only successfully encode very small files or placeholders.
         */
        window.previewImages = (input, previewId) => {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            const files = Array.from(input.files).slice(0, 5);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML += `<img src="${e.target.result}" class="w-16 h-16 object-cover rounded-md shadow">`;
                };
                reader.readAsDataURL(file);
            });
        };
        
        /**
         * Submits a new cleaning request (public access).
         */
        window.submitCleaningRequest = async () => {
            const message = document.getElementById('request-message').value.trim();
            const photoInput = document.getElementById('request-photo-input');
            
            if (!message) {
                window.showMessage('ìš”ì²­ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // Simulate file reading and get Base64 strings
                const requestPhotos = [];
                for (const file of Array.from(photoInput.files).slice(0, 5)) {
                    // This is a simplified, non-awaiting way to get base64. 
                    // For a fully robust solution, use Promises and async/await.
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    requestPhotos.push(base64);
                }
                
                const requestsCollectionRef = getPublicCollectionRef('cleaning_requests');

                await addDoc(requestsCollectionRef, {
                    requestMessage: message,
                    requestPhotos: requestPhotos,
                    status: 'ëŒ€ê¸°', // 'ëŒ€ê¸°', 'ì‘ì—…ì¤‘', 'ì™„ë£Œ'
                    timestamp: new Date(),
                });

                document.getElementById('request-message').value = '';
                photoInput.value = '';
                document.getElementById('request-preview').innerHTML = '';
                window.showMessage('ì²­ì†Œ ìš”ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error("Error adding cleaning request:", error);
                window.showMessage(`ìš”ì²­ ì œì¶œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Updates request status to 'ì‘ì—…ì¤‘' (Supervisor/Admin only).
         */
        window.updateRequestStatus = async (requestId, newStatus) => {
            try {
                // 6 segments path: artifacts/{appId}/public/data/cleaning_requests/{requestId} (Correct for Document)
                const requestRef = getPublicConfigDocRef('cleaning_requests', requestId); 
                await updateDoc(requestRef, { status: newStatus });
                window.showMessage(`ìƒíƒœê°€ ${newStatus}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Error updating request status:", error);
                window.showMessage(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Opens the form to complete a request.
         */
        window.openCompletionForm = (requestId) => {
            const request = window.state.requests.find(r => r.id === requestId);
            
            // Temporary simple modal for completion input
            const completionMessage = prompt(`ìš”ì²­ ì™„ë£Œ: [${request.requestMessage.substring(0, 20)}...]\n\nì™„ë£Œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            
            if (completionMessage !== null) {
                // In a proper app, this would be a full modal with file upload inputs.
                // For this simple example, we ask for a simulated photo count.
                let photoCount = 0;
                let validCount = false;
                while (!validCount) {
                    const countInput = prompt('ìµœëŒ€ 5ê°œì˜ ì™„ë£Œ ì‚¬ì§„ì„ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëª‡ ê°œì˜ ì‚¬ì§„ì„ ì²¨ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (0ì—ì„œ 5 ì‚¬ì´ì˜ ìˆ«ì ì…ë ¥)');
                    photoCount = parseInt(countInput);
                    if (isNaN(photoCount) || photoCount < 0 || photoCount > 5) {
                        alert('0ì—ì„œ 5 ì‚¬ì´ì˜ ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    } else {
                        validCount = true;
                    }
                }
                
                // Simplified Base64 Placeholder
                const completionPhotos = Array(photoCount).fill(`DEMO_COMPLETION_BASE64_${requestId}_`);
                
                window.checkPassword('supervisor', () => completeRequest(requestId, completionMessage, completionPhotos));
            }
        };
        
        /**
         * Marks a request as complete with photos and message (Supervisor/Admin only).
         */
        window.completeRequest = async (requestId, completionMessage, completionPhotos) => {
             try {
                // 6 segments path: artifacts/{appId}/public/data/cleaning_requests/{requestId} (Correct for Document)
                const requestRef = getPublicConfigDocRef('cleaning_requests', requestId);
                await updateDoc(requestRef, { 
                    status: 'ì™„ë£Œ',
                    completionMessage: completionMessage,
                    completionPhotos: completionPhotos,
                    completedAt: new Date(),
                });
                window.showMessage('ì‘ì—… ì™„ë£Œ ë³´ê³ ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error("Error completing request:", error);
                window.showMessage(`ì™„ë£Œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Opens the Inventory In/Out Modal. (Localized to English)
         */
        window.openIOModal = (itemId, itemName) => {
            window.state.inventoryActionContext = { itemId, itemName };
            
            document.getElementById('io-modal-title').textContent = `${itemName} ì…/ì¶œê³ `;
            document.getElementById('io-item-name').textContent = itemName;
            document.getElementById('io-quantity').value = 1;
            document.getElementById('io-memo').value = '';

            // Localize Modal Content
            document.querySelector('#io-modal label[for="io-type"]').textContent = 'êµ¬ë¶„';
            document.querySelector('#io-modal option[value="in"]').textContent = 'ì…ê³ ';
            document.querySelector('#io-modal option[value="out"]').textContent = 'ì¶œê³ ';
            document.querySelector('#io-modal label[for="io-quantity"]').textContent = 'ìˆ˜ëŸ‰';
            document.getElementById('io-quantity').placeholder = 'ìˆ˜ëŸ‰ ì…ë ¥';
            document.querySelector('#io-modal label[for="io-memo"]').textContent = 'ë©”ëª¨ (ì„ íƒ)';
            document.getElementById('io-memo').placeholder = 'ê°„ë‹¨í•œ ë©”ëª¨';
            document.querySelector('#io-modal button:last-child').textContent = 'ì €ì¥';
            document.querySelector('#io-modal button:first-child').textContent = 'ì·¨ì†Œ';
            document.querySelector('#io-modal p.text-gray-600').innerHTML = `í˜„ì¬ í•­ëª©: <span id="io-item-name" class="font-semibold text-blue-600">${itemName}</span>`;


            const modal = document.getElementById('io-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeIOModal = () => {
            document.getElementById('io-modal').classList.remove('flex');
            document.getElementById('io-modal').classList.add('hidden');
            window.state.inventoryActionContext = null;
        };

        /**
         * Performs the actual inventory log action after password check (Supervisor/Admin only).
         */
        window.performInventoryAction = () => {
            // [FIX 1] checkPasswordê°€ í˜¸ì¶œë˜ì–´ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ì´ ëœ° ë•Œ,
            // ì´ ëª¨ë‹¬(io-modal)ì€ ë°°ê²½ì— ìˆ¨ê²¨ì ¸ ìˆìœ¼ë¯€ë¡œ, Z-index ìˆ˜ì •ìœ¼ë¡œ í•´ê²°ë©ë‹ˆë‹¤.
            window.checkPassword('supervisor', executeInventoryLog);
        };

        window.executeInventoryLog = async () => {
            const context = window.state.inventoryActionContext;
            if (!context) return;

            const type = document.getElementById('io-type').value;
            const quantity = parseInt(document.getElementById('io-quantity').value);
            const memo = document.getElementById('io-memo').value;

            if (isNaN(quantity) || quantity <= 0) {
                window.showMessage('ìœ íš¨í•œ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);

                await addDoc(collection(userDocRef, 'itac_inventory_logs'), {
                    itemId: context.itemId,
                    itemName: context.itemName,
                    type: type, // 'in' or 'out'
                    quantity: quantity,
                    memo: memo,
                    timestamp: new Date(),
                });

                window.showMessage(`${context.itemName} ${type === 'in' ? 'ì…ê³ ' : 'ì¶œê³ '} ${quantity}ê°œê°€ ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                closeIOModal();

            } catch (error) {
                console.error("Error recording inventory log:", error);
                window.showMessage(`ì¬ê³  ê¸°ë¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };
        
        // --- Settings Action Functions (Admin Only) ---
        
        /**
         * Updates Admin/Supervisor Passwords.
         */
        window.updatePasswords = async () => {
            const adminPw = document.getElementById('admin-pw').value;
            const supervisorPw = document.getElementById('supervisor-pw').value;
            
            const newPasswords = { ...window.state.settings.passwords };
            let changes = false;
            
            if (adminPw) {
                newPasswords.admin = adminPw;
                changes = true;
            }
            if (supervisorPw) {
                newPasswords.supervisor = supervisorPw;
                changes = true;
            }

            if (!changes) {
                window.showMessage('ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'info');
                return;
            }
            
            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                await updateDoc(userDocRef, { passwords: newPasswords });
                window.showMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                document.getElementById('admin-pw').value = '';
                document.getElementById('supervisor-pw').value = '';
            } catch (error) {
                console.error("Error updating passwords:", error);
                window.showMessage(`ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Updates Weekly Plan.
         */
        window.updateWeeklyPlan = async () => {
            const newPlan = [];
            for (let i = 0; i < 10; i++) {
                const day = document.getElementById(`plan-day-${i}`).value;
                const task = document.getElementById(`plan-task-${i}`).value;
                newPlan.push({ day, task });
            }
            
            try {
                // Use the 6-segment config document path
                const planDocRef = getPublicConfigDocRef('itac_plan');
                await setDoc(planDocRef, { weeklyPlan: newPlan });
                window.showMessage('ì£¼ê°„ ì²­ì†Œ ê³„íšì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error("Error updating weekly plan:", error);
                window.showMessage(`ê³„íš ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };
        
        /**
         * Updates Safety Stock Levels.
         */
        window.updateSafetyStock = async () => {
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];
            const newLevels = {};
            
            allItems.forEach(item => {
                const input = document.getElementById(`safety-stock-${item.id}`);
                const value = parseInt(input.value);
                if (!isNaN(value) && value >= 0) {
                    newLevels[item.id] = value;
                }
            });
            
            try {
                // Use the 6-segment config document path
                const safetyStockDocRef = getPublicConfigDocRef('itac_safety_stock');
                await setDoc(safetyStockDocRef, { levels: newLevels });
                window.showMessage('ì•ˆì „ ì¬ê³  ìˆ˜ì¤€ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error("Error updating safety stock:", error);
                window.showMessage(`ì•ˆì „ ì¬ê³  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };


        /**
         * Adds a new inventory item.
         */
        window.addInventoryItem = async () => {
            const name = document.getElementById('new-item-name').value.trim();
            const category = document.getElementById('new-item-category').value;
            const reorderLevel = parseInt(document.getElementById('new-item-reorder-level').value);

            if (!name || isNaN(reorderLevel) || reorderLevel < 0) {
                window.showMessage('í•­ëª© ì´ë¦„ê³¼ ì¬ì£¼ë¬¸ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // Generate a simple ID
            const itemId = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now().toString().slice(-4);
            const newItem = { id: itemId, name, category, reorderLevel };

            const currentList = window.state.settings[category];
            if (currentList.some(item => item.name === name)) {
                window.showMessage('í•­ëª© ì´ë¦„ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            const newList = [...currentList, newItem];
            
            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                await updateDoc(userDocRef, { [category]: newList });
                
                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-reorder-level').value = '10';
                window.showMessage(`${name} (${category === 'consumable' ? 'ì†Œëª¨í’ˆ' : 'ì²­ì†Œ ìš©í’ˆ'}) í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("Error adding item:", error);
                window.showMessage(`í•­ëª© ì¶”ê°€ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        };

        /**
         * Deletes an inventory item.
         */
        window.deleteInventoryItem = async (itemId, category) => {
            window.checkPassword('admin', async () => {
                const currentList = window.state.settings[category];
                const newList = currentList.filter(item => item.id !== itemId);
                
                if (newList.length === currentList.length) {
                    window.showMessage('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                try {
                    const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                    await updateDoc(userDocRef, { [category]: newList });
                    window.showMessage(`í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } catch (error) {
                    console.error("Error deleting item:", error);
                    window.showMessage(`í•­ëª© ì‚­ì œ ì˜¤ë¥˜: ${error.message}`, 'error');
                }
            });
        };
        
        // --- Reports Action Functions ---

        /**
         * Filters the inventory logs based on selected date range.
         */
        window.filterLogs = () => {
            const startDateStr = document.getElementById('report-start-date').value;
            const endDateStr = document.getElementById('report-end-date').value;
            const container = document.getElementById('report-table-container');

            let filteredLogs = window.state.inventoryLogs;

            if (startDateStr) {
                const startTimestamp = new Date(startDateStr).getTime();
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp.seconds * 1000).getTime() >= startTimestamp);
            }
            
            if (endDateStr) {
                // Set end date to midnight of the next day to include the entire end day
                const endDate = new Date(endDateStr);
                endDate.setDate(endDate.getDate() + 1);
                const endTimestamp = endDate.getTime();
                
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp.seconds * 1000).getTime() < endTimestamp);
            }

            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">ê¸°ê°„ë³„ ì¬ê³  ê¸°ë¡ (${startDateStr || 'ì „ì²´'} ~ ${endDateStr || 'ì „ì²´'})</h3>
                ${renderLogTable(filteredLogs)}
            `;
            lucide.createIcons();
        };


        /**
         * Simulates Excel export functionality.
         */
        window.exportToExcel = () => {
             // In a real application, you'd use a library like SheetJS or create a proper CSV/XLSX file.
             // Here, we simulate by collecting the log data and prompting a copy.
            
            window.checkPassword('supervisor', () => {
                const logs = window.state.inventoryLogs; // Use all logs for export simulation
                
                const header = ["ë‚ ì§œ", "í•­ëª©", "êµ¬ë¶„", "ìˆ˜ëŸ‰", "ë©”ëª¨"].join('\t');
                const rows = logs.map(log => [
                    new Date(log.timestamp.seconds * 1000).toLocaleDateString('ko-KR'),
                    log.itemName,
                    log.type === 'in' ? 'ì…ê³ ' : 'ì¶œê³ ',
                    log.quantity,
                    log.memo || '-'
                ].join('\t'));

                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [header, ...rows].join('\n');
                
                // Simulate download
                const link = document.createElement('a');
                link.setAttribute('href', csvContent);
                link.setAttribute('download', 'ITAC_Inventory_Report.csv');
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
                
                window.showMessage('Excel íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (CSV í˜•ì‹).', 'info');
            });
        };


        // --- Startup ---
        window.onload = window.setupFirebase;
    </script>
</body>
</html>