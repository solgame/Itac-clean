<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITAC 청소관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom: 4px solid #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center py-6 bg-white shadow-lg rounded-xl mb-6">
            <h1 class="text-4xl font-extrabold text-blue-700 tracking-tight">ITAC 청소 관리 시스템</h1>
            <p id="auth-status" class="mt-2 text-sm text-gray-500">
                <span id="loading-spinner" class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent mr-2"></span>
                초기화 중...
            </p>
        </header>

        <nav class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-0 z-10">
            <button class="tab-button active px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('home')">메인</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('requests')">청소 요청</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('reports')">재고 보고서</button>
            <button class="tab-button px-4 py-2 mx-2 text-lg text-gray-600 hover:text-blue-500" onclick="changeView('settings')">설정</button>
        </nav>

        <main id="main-content" class="min-h-[500px]">
            </main>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all scale-100 duration-300">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="modal-title">비밀번호 확인</h3>
            <p class="text-sm text-gray-600 mb-4" id="modal-role-info">액션을 진행하려면 비밀번호를 입력하세요.</p>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="비밀번호 입력">
            <div class="flex justify-end space-x-3">
                <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" onclick="closePasswordModal()">취소</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="submitPassword()">확인</button>
            </div>
        </div>
    </div>

    <div id="io-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg transform transition-all scale-100 duration-300">
            <h3 class="text-2xl font-bold mb-4 text-gray-800" id="io-modal-title">재고 입/출고</h3>
            <p class="text-gray-600 mb-4">현재 항목: <span id="io-item-name" class="font-semibold text-blue-600"></span></p>

            <div class="mb-4">
                <label for="io-type" class="block text-sm font-medium text-gray-700 mb-1">구분</label>
                <select id="io-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="in">입고</option>
                    <option value="out">출고</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="io-quantity" class="block text-sm font-medium text-gray-700 mb-1">수량</label>
                <input type="number" id="io-quantity" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="수량 입력" min="1">
            </div>
            <div class="mb-6">
                <label for="io-memo" class="block text-sm font-medium text-gray-700 mb-1">메모 (선택)</label>
                <input type="text" id="io-memo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="간단한 메모">
            </div>

            <div class="flex justify-end space-x-3">
                <button class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition" onclick="closeIOModal()">취소</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" onclick="performInventoryAction()">저장</button>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="fixed bottom-4 right-4 z-50"></div>

    <script type="module">
        // Import Firebase SDKs (v11.6.1 for stability with the code structure)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs, updateDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Variables
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAdmin = false;
        window.isSupervisor = false;
        
        // --- Firebase Initialization and Auth ---

        // 🚨🚨🚨 사용자님의 Firebase 설정 정보가 적용되었습니다. 🚨🚨🚨
        const firebaseConfig = {
            apiKey: "AIzaSyD6-IKznyhHIH6eGztJOioL0cDQ57MvNvs",
            authDomain: "rtu-system-han.firebaseapp.com",
            databaseURL: "https://rtu-system-han-default-rtdb.firebaseio.com",
            projectId: "rtu-system-han",
            storageBucket: "rtu-system-han.firebasestorage.app",
            messagingSenderId: "960060003353",
            appId: "1:960060003353:web:25be936a3d3ebea8b0c688",
            measurementId: "G-D0KT7KEC1H"
        };
        
        // 프로젝트 ID를 앱의 고유 ID로 사용합니다.
        const appId = firebaseConfig.projectId; 
        // 익명 로그인을 사용하므로 초기 인증 토큰은 null입니다.
        const initialAuthToken = null; 
        
        // 🚨🚨🚨 END OF FIREBASE CONFIGURATION 🚨🚨🚨


        // Application State
        window.state = {
            currentView: 'home',
            settings: {
                weeklyPlan: Array(10).fill({ day: '월요일', task: '' }),
                safetyStock: {},
                consumables: [
                    { id: 'toilet_paper', name: '화장실 휴지', category: 'consumable', reorderLevel: 50 },
                    { id: 'liquid_soap', name: '물비누', category: 'consumable', reorderLevel: 20 },
                    { id: 'paper_towel', name: '페이퍼 타월', category: 'consumable', reorderLevel: 30 },
                    { id: 'trash_bag_l', name: '검정 쓰레기 봉투(대)', category: 'consumable', reorderLevel: 10 },
                    { id: 'trash_bag_s', name: '쓰레기통 봉투(소)', category: 'consumable', reorderLevel: 10 },
                ],
                supplies: [
                    { id: 'nabc', name: 'NABC', category: 'supply', reorderLevel: 5 },
                    { id: 'bleach', name: 'Bleach', category: 'supply', reorderLevel: 3 },
                    { id: 'xcelente', name: 'Xcelente', category: 'supply', reorderLevel: 4 },
                    { id: 'eco_lyzer', name: 'Eco-Lyzer', category: 'supply', reorderLevel: 4 },
                    { id: 'fast_easy', name: 'Fast & easy', category: 'supply', reorderLevel: 5 },
                    { id: 'wipes', name: 'Wipes', category: 'supply', reorderLevel: 10 },
                    { id: 'gloves_m', name: 'Gloves M', category: 'supply', reorderLevel: 10 },
                    { id: 'pine_sol', name: 'Pine-sol', category: 'supply', reorderLevel: 5 },
                    { id: 'brown_bag', name: 'brown bag', category: 'supply', reorderLevel: 10 },
                ],
                // 사용자 요청에 따라 관리자/수퍼바이저 비밀번호를 0000/1111로 변경
                passwords: { admin: '0000', supervisor: '1111' } // Initial default passwords as requested by user
            },
            inventory: {}, // Current stock calculated from logs
            requests: [], // List of cleaning requests
            inventoryLogs: [], // All inventory logs
            isAuthReady: false,
            passwordCallback: null,
            passwordRole: null,
            inventoryActionContext: null,
        };

        /**
         * Converts base64 image data (simulated) to a URL for display.
         */
        window.toImageUrl = (base64) => base64 ? `data:image/png;base64,${base64}` : 'https://placehold.co/100x100/f3f4f6/9ca3af?text=No+Image';

        /**
         * Global function to display a temporary message. (Localized to English)
         */
        // [FIX 2] 메시지가 사라지지 않는 문제 해결을 위해 로직 수정 (유지)
        window.showMessage = (message, type = 'success') => {
            const box = document.getElementById('message-box');
            let bgColor = 'bg-green-500';
            let icon = 'check-circle';

            if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = 'alert-triangle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                icon = 'info';
            }

            // [FIX 2] animate-in 클래스는 그대로 두어 등장 애니메이션을 시도하지만, 제거 로직은 수동으로 처리합니다.
            const messageHtml = `
                <div class="${bgColor} text-white p-4 rounded-lg shadow-xl mb-3 flex items-center transform transition-all duration-300">
                    <i data-lucide="${icon}" class="w-5 h-5 mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            box.insertAdjacentHTML('beforeend', messageHtml);
            lucide.createIcons();

            const latestMessage = box.lastElementChild;
            
            // 3초 후 페이드 아웃 시작
            setTimeout(() => {
                // 페이드 아웃 효과를 위한 CSS 속성 적용
                latestMessage.style.transition = 'opacity 0.5s ease-in-out';
                latestMessage.style.opacity = '0';
                
                // 0.5초 후 완전히 제거
                setTimeout(() => {
                    latestMessage.remove();
                }, 500);
            }, 3000); // 3.0초 대기
        };

        /**
         * Initializes Firebase and sets up authentication/listeners. (Localized to English)
         */
        window.setupFirebase = async () => {
            try {
                // Set Firestore logging to Debug for visibility in console
                setLogLevel('Debug');
                
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Auth state listener
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('auth-status').innerHTML = `
                            사용자 ID: <span class="font-mono text-xs p-1 bg-gray-100 rounded">${window.userId}</span> |
                            <span class="text-green-600">인증됨</span>
                        `;
                        // Start listening to data only after successful authentication
                        window.state.isAuthReady = true;
                        window.setupDataListeners();
                        window.render();
                    } else {
                        document.getElementById('auth-status').innerHTML = `<span class="text-red-600">인증 실패</span>`;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                window.showMessage(`Firebase 초기화 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Helper function to get a reference to a document in the public data path.
         * The path structure is: artifacts/{appId}/public/data/{collectionName}/{documentId}
         */
        const getPublicConfigDocRef = (collectionName, documentId = 'config') => {
             // 4 segment document ref: artifacts/{appId}/public/data
            const publicRootDocRef = doc(window.db, 'artifacts', appId, 'public', 'data');
            // 5 segment collection ref: artifacts/{appId}/public/data/{collectionName}
            const collectionRef = collection(publicRootDocRef, collectionName);
            // 6 segment document ref: artifacts/{appId}/public/data/{collectionName}/{documentId}
            return doc(collectionRef, documentId);
        }

        /**
         * Helper function to get a reference to a public collection (5 segments).
         */
        const getPublicCollectionRef = (collectionName) => {
             // 4 segment document ref: artifacts/{appId}/public/data
            const publicRootDocRef = doc(window.db, 'artifacts', appId, 'public', 'data');
            // 5 segment collection ref: artifacts/{appId}/public/data/{collectionName}
            return collection(publicRootDocRef, collectionName);
        }

        /**
         * Sets up real-time listeners for all necessary data.
         */
        window.setupDataListeners = () => {
            if (!window.state.isAuthReady || !window.db) return;

            const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
            
            // 1. Settings (Admin's Private Data for Passwords/Master Lists)
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.state.settings.passwords = data.passwords || window.state.settings.passwords;
                    window.state.settings.consumables = data.consumables || window.state.settings.consumables;
                    window.state.settings.supplies = data.supplies || data.supplies;
                } else {
                    // Initialize settings if it's the first run for this user
                    // This sets initial passwords and inventory lists.
                    setDoc(userDocRef, {
                        passwords: window.state.settings.passwords,
                        consumables: window.state.settings.consumables,
                        supplies: window.state.settings.supplies,
                    }, { merge: true });
                }
            });

            // 2. Weekly Plan (Public Data - Config document in the collection)
            const planDocRef = getPublicConfigDocRef('itac_plan');
            onSnapshot(planDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.state.settings.weeklyPlan = docSnap.data().weeklyPlan || window.state.settings.weeklyPlan;
                } else {
                    setDoc(planDocRef, { weeklyPlan: window.state.settings.weeklyPlan });
                }
                window.render();
            });
            
            // 3. Safety Stock Levels (Public Data - Config document in the collection)
            const safetyStockDocRef = getPublicConfigDocRef('itac_safety_stock');
            onSnapshot(safetyStockDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.state.settings.safetyStock = docSnap.data().levels || {};
                }
                window.render();
            });

            // 4. Inventory Logs (Private Data - Admin/Supervisor managed)
            onSnapshot(collection(userDocRef, 'itac_inventory_logs'), (snapshot) => {
                window.state.inventoryLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.calculateInventory(); // Recalculate stock and re-render
            });

            // 5. Cleaning Requests (Public Data - Collection)
            const requestsCollectionRef = getPublicCollectionRef('cleaning_requests');
            // NOTE: Firestore requires an index for orderBy. To avoid user-side indexing issues, 
            // the sorting is done in memory. (Removed `orderBy` from query).
            onSnapshot(requestsCollectionRef, (snapshot) => {
                window.state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); // Sort by timestamp DESC
                window.render();
            });

        };

        // --- Inventory Logic ---

        /**
         * Recalculates current inventory stock levels from the logs.
         */
        window.calculateInventory = () => {
            const stock = {};
            window.state.inventoryLogs.forEach(log => {
                stock[log.itemId] = stock[log.itemId] || 0;
                if (log.type === 'in') {
                    stock[log.itemId] += log.quantity;
                } else if (log.type === 'out') {
                    stock[log.itemId] -= log.quantity;
                }
            });
            window.state.inventory = stock;
            window.render();
        };

        // --- Authentication & Security Logic (Password Check) (Localized to English) ---

        /**
         * Checks user-entered password against Admin/Supervisor passwords.
         * @param {string} role 'admin' or 'supervisor'
         * @param {function} callback Function to execute on success
         */
        window.checkPassword = (role, callback) => {
            const modal = document.getElementById('password-modal');
            const title = document.getElementById('modal-title');
            const roleInfo = document.getElementById('modal-role-info');
            const confirmBtn = modal.querySelector('button:last-child');
            const cancelBtn = modal.querySelector('button:first-child');

            // Set state for the modal
            window.state.passwordCallback = callback;
            window.state.passwordRole = role;

            title.textContent = `${role === 'admin' ? '관리자' : '수퍼바이저'} 비밀번호 확인`;
            roleInfo.textContent = `이 작업은 ${role === 'admin' ? '관리자' : '관리자 또는 수퍼바이저'} 권한이 필요합니다.`;
            document.getElementById('password-input').value = '';
            
            confirmBtn.textContent = '확인';
            cancelBtn.textContent = '취소';
            document.getElementById('password-input').placeholder = '비밀번호 입력';
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.submitPassword = () => {
            const password = document.getElementById('password-input').value;
            const role = window.state.passwordRole;
            const passwords = window.state.settings.passwords;
            let success = false;
            
            // [FIX] closePasswordModal()이 window.state.passwordCallback을 null로 만들기 전에 콜백을 저장합니다.
            const storedCallback = window.state.passwordCallback; 

            if (role === 'admin' && password === passwords.admin) {
                success = true;
                window.isAdmin = true;
            } else if (role === 'supervisor' && (password === passwords.admin || password === passwords.supervisor)) {
                success = true;
                // Note: Admin also passes supervisor check
                window.isAdmin = (password === passwords.admin);
                window.isSupervisor = (password === passwords.supervisor);
            }

            closePasswordModal(); // 이 함수는 window.state.passwordCallback을 null로 설정합니다.

            if (success && typeof storedCallback === 'function') { // 저장된 콜백이 함수인지 확인 후 실행
                storedCallback();
                window.showMessage('비밀번호가 성공적으로 확인되었습니다!', 'success');
            } else if (!success) {
                window.showMessage('비밀번호가 일치하지 않습니다.', 'error');
            }
        };

        window.closePasswordModal = () => {
            document.getElementById('password-modal').classList.remove('flex');
            document.getElementById('password-modal').classList.add('hidden');
            window.state.passwordCallback = null;
            window.state.passwordRole = null;
            window.isAdmin = false;
            window.isSupervisor = false;
        };

        // --- UI Rendering ---

        /**
         * Changes the active view and re-renders.
         */
        window.changeView = (view) => {
            window.state.currentView = view;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="changeView('${view}')"]`).classList.add('active');
            window.render();
        };
        
        /**
         * Main rendering function based on current state.
         */
        window.render = () => {
            const content = document.getElementById('main-content');
            content.innerHTML = '';
            lucide.createIcons(); // Re-create lucide icons after injecting new HTML

            switch (window.state.currentView) {
                case 'home':
                    content.innerHTML = window.renderHome();
                    break;
                case 'requests':
                    content.innerHTML = window.renderRequests();
                    break;
                case 'settings':
                    content.innerHTML = window.renderSettings();
                    break;
                case 'reports':
                    content.innerHTML = window.renderReports();
                    break;
                default:
                    content.innerHTML = window.renderHome();
            }

            // Re-initialize icons
            lucide.createIcons();
        };

        // --- View Renderers (Mostly Localized to English) ---

        window.renderHome = () => {
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];
            const reorderAlerts = allItems.filter(item => {
                const currentStock = window.state.inventory[item.id] || 0;
                const reorderLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                return currentStock <= reorderLevel;
            });
            
            const weeklyPlanRows = window.state.settings.weeklyPlan.map((plan, index) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-medium text-gray-900">${plan.day || 'N/A'}</td>
                    <td class="p-3 text-gray-700">${plan.task || '계획 없음'}</td>
                </tr>
            `).join('');

            const inventoryHtml = (items, title) => `
                <h3 class="text-2xl font-semibold mb-4 text-gray-700">${title}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${items.map(item => {
                        const currentStock = window.state.inventory[item.id] || 0;
                        const reorderLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                        const isAlert = currentStock <= reorderLevel;
                        return `
                            <div class="bg-white p-5 rounded-xl shadow-lg border ${isAlert ? 'border-red-500 ring-4 ring-red-100' : 'border-gray-200'} cursor-pointer hover:shadow-xl transition" onclick="openIOModal('${item.id}', '${item.name}')">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-bold text-lg text-gray-800">${item.name}</h4>
                                    ${isAlert ? '<i data-lucide="bell-ring" class="w-6 h-6 text-red-500 animate-pulse"></i>' : ''}
                                </div>
                                <p class="text-sm text-gray-600">현재 재고: <span class="text-2xl font-extrabold ${isAlert ? 'text-red-600' : 'text-blue-600'}">${currentStock}</span> 개</p>
                                <p class="text-xs text-gray-500 mt-1">안전 재고: ${reorderLevel}</p>
                                ${isAlert ? '<p class="text-xs font-bold text-red-500 mt-2">🚨 재고 부족 알림</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4 flex items-center">
                        <i data-lucide="calendar" class="w-7 h-7 mr-2"></i>
                        주간 청소 계획
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-1/4">요일/분류</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-3/4">계획 상세</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${weeklyPlanRows}
                            </tbody>
                        </table>
                    </div>
                </div>

                ${reorderAlerts.length > 0 ? `
                    <div class="bg-red-50 p-5 rounded-xl border border-red-300 shadow-md mb-6">
                        <h2 class="text-2xl font-bold text-red-600 mb-3 flex items-center">
                            <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>
                            긴급 재고 부족 알림
                        </h2>
                        <ul class="list-disc list-inside text-red-700 space-y-1">
                            ${reorderAlerts.map(item => `
                                <li><strong>${item.name}</strong>: 현재 재고 ${window.state.inventory[item.id] || 0} (안전 재고 ${window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel})</li>
                            `).join('')}
                        </ul>
                    </div>
                ` : `<div class="bg-green-50 p-4 rounded-xl shadow-md mb-6 text-green-700 font-medium flex items-center">
                    <i data-lucide="thumbs-up" class="w-5 h-5 mr-2"></i>
                    모든 재고 수준이 충분합니다.
                </div>`}

                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        ${inventoryHtml(window.state.settings.consumables, '소모품 재고 현황 (입/출고를 위해 항목 클릭)')}
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        ${inventoryHtml(window.state.settings.supplies, '청소 용품 재고 현황 (입/출고를 위해 항목 클릭)')}
                    </div>
                </div>
            `;
        };

        window.renderRequests = () => {
            const requestsHtml = window.state.requests.length > 0 ? window.state.requests.map(req => `
                <div class="bg-white p-5 rounded-xl shadow-md border ${req.status === '완료' ? 'border-green-300' : req.status === '작업중' ? 'border-blue-300' : 'border-gray-300'}">
                    <div class="flex justify-between items-start mb-3 border-b pb-3">
                        <span class="text-sm text-gray-500">${new Date(req.timestamp.seconds * 1000).toLocaleString('ko-KR')}</span>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${req.status === '완료' ? 'bg-green-100 text-green-800' : req.status === '작업중' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${req.status}</span>
                    </div>
                    <p class="text-lg font-semibold mb-3">요청 메시지:</p>
                    <p class="text-gray-700 mb-4 p-3 bg-gray-50 rounded-lg whitespace-pre-wrap">${req.requestMessage}</p>

                    <div class="mb-4">
                        <p class="text-md font-medium text-gray-700 mb-2">요청 사진:</p>
                        <div class="flex flex-wrap gap-2">
                            ${req.requestPhotos ? req.requestPhotos.map(p => `<img src="${window.toImageUrl(p)}" class="w-20 h-20 object-cover rounded-md shadow" onerror="this.src='https://placehold.co/80x80/cccccc/333333?text=Load+Error';">`).join('') : '<p class="text-sm text-gray-500">사진 없음</p>'}
                        </div>
                    </div>

                    ${req.status === '완료' ? `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <p class="text-lg font-semibold mb-3 text-green-600">완료 보고서:</p>
                            <p class="text-gray-700 mb-4 p-3 bg-green-50 rounded-lg whitespace-pre-wrap">${req.completionMessage || '메시지 없음'}</p>
                            <p class="text-md font-medium text-gray-700 mb-2">완료 사진:</p>
                            <div class="flex flex-wrap gap-2">
                                ${req.completionPhotos ? req.completionPhotos.map(p => `<img src="${window.toImageUrl(p)}" class="w-20 h-20 object-cover rounded-md shadow" onerror="this.src='https://placehold.co/80x80/cccccc/333333?text=Load+Error';">`).join('') : '<p class="text-sm text-gray-500">사진 없음</p>'}
                            </div>
                        </div>
                    ` : ''}

                    <div class="mt-4 pt-4 border-t border-gray-100 flex space-x-2">
                        ${req.status === '대기' ? `
                            <button class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-blue-600 transition" onclick="checkPassword('supervisor', () => updateRequestStatus('${req.id}', '작업중'))">작업 중으로 변경</button>
                        ` : ''}
                        ${req.status === '작업중' ? `
                            <button class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-green-600 transition" onclick="openCompletionForm('${req.id}')">작업 완료 보고</button>
                        ` : ''}
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-500 text-lg py-10 bg-white rounded-xl shadow-md">현재 게시된 청소 요청이 없습니다.</p>';

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-lg sticky top-[100px]">
                            <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                                <i data-lucide="plus-circle" class="w-6 h-6 mr-2"></i>
                                새로운 청소 요청 (전체 사용자)
                            </h2>
                            <textarea id="request-message" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3" placeholder="상세 요청 메시지를 입력하세요."></textarea>
                            
                            <label class="block text-sm font-medium text-gray-700 mb-1">사진 첨부 (최대 5개, Base64 시뮬레이션)</label>
                            <input type="file" id="request-photo-input" accept="image/*" multiple max="5" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4" onchange="previewImages(this, 'request-preview')">
                            
                            <div id="request-preview" class="flex flex-wrap gap-2 mb-4"></div>

                            <button class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="submitCleaningRequest()">요청 제출</button>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-4" id="request-list-container">
                        <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                            <i data-lucide="list-ordered" class="w-6 h-6 mr-2"></i>
                            전체 요청 목록
                        </h2>
                        ${requestsHtml}
                    </div>
                </div>
            `;
        };

        window.renderSettings = () => {
            const currentPasswords = window.state.settings.passwords;
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];

            const itemRows = (items) => items.map(item => `
                <li class="flex justify-between items-center p-3 border-b last:border-b-0 hover:bg-gray-50">
                    <span class="text-gray-700">${item.name} (ID: ${item.id})</span>
                    <button class="text-red-500 hover:text-red-700 p-1 rounded-full" onclick="deleteInventoryItem('${item.id}', '${item.category}')">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </li>
            `).join('');
            
            const safetyStockRows = allItems.map(item => {
                const currentLevel = window.state.settings.safetyStock[item.id] !== undefined ? window.state.settings.safetyStock[item.id] : item.reorderLevel;
                return `
                    <div class="flex items-center space-x-4 p-3 border-b hover:bg-gray-50">
                        <span class="w-1/3 text-gray-700 font-medium">${item.name}</span>
                        <input type="number" id="safety-stock-${item.id}" value="${currentLevel}" min="0" class="w-1/4 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-center">
                        <span class="text-sm text-gray-500">개 (이 수준 이하로 떨어지면 알림)</span>
                    </div>
                `;
            }).join('');


            return `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="key" class="w-6 h-6 mr-2"></i>
                            관리자/수퍼바이저 비밀번호 설정
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label for="admin-pw" class="block text-sm font-medium text-gray-700">관리자 비밀번호 (현재: ${currentPasswords.admin ? '설정됨' : '미설정'})</label>
                                <input type="password" id="admin-pw" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="새 관리자 비밀번호">
                            </div>
                            <div>
                                <label for="supervisor-pw" class="block text-sm font-medium text-gray-700">수퍼바이저 비밀번호 (현재: ${currentPasswords.supervisor ? '설정됨' : '미설정'})</label>
                                <input type="password" id="supervisor-pw" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="새 수퍼바이저 비밀번호">
                            </div>
                            <button class="bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updatePasswords)">비밀번호 저장 (관리자 전용)</button>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="calendar-plus" class="w-6 h-6 mr-2"></i>
                            주간 청소 계획 설정 (10줄)
                        </h2>
                        <div id="weekly-plan-editor" class="space-y-3">
                            ${window.state.settings.weeklyPlan.map((plan, index) => `
                                <div class="flex space-x-3 items-center">
                                    <select id="plan-day-${index}" class="p-2 border border-gray-300 rounded-lg w-1/4">
                                        ${['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일', '특이사항'].map(d => `<option value="${d}" ${plan.day === d ? 'selected' : ''}>${d}</option>`).join('')}
                                    </select>
                                    <input type="text" id="plan-task-${index}" value="${plan.task}" class="p-2 border border-gray-300 rounded-lg w-3/4" placeholder="청소 작업 내용">
                                </div>
                            `).join('')}
                        </div>
                        <button class="mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updateWeeklyPlan)">주간 계획 저장 (관리자 전용)</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="shield" class="w-6 h-6 mr-2"></i>
                            안전 재고/재주문 수량 설정
                        </h2>
                        <div id="safety-stock-editor" class="space-y-2">
                            ${safetyStockRows}
                        </div>
                        <button class="mt-4 bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition" onclick="checkPassword('admin', updateSafetyStock)">안전 재고 저장 (관리자 전용)</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <i data-lucide="list-plus" class="w-6 h-6 mr-2"></i>
                            재고 항목 추가/삭제 (관리자 전용)
                        </h2>
                        
                        <div class="flex space-x-4 mb-6">
                            <input type="text" id="new-item-name" class="p-3 border border-gray-300 rounded-lg w-1/3" placeholder="새 항목 이름">
                            <select type="text" id="new-item-category" class="p-3 border border-gray-300 rounded-lg w-1/3">
                                <option value="consumable">소모품</option>
                                <option value="supply">청소 용품</option>
                            </select>
                            <input type="number" id="new-item-reorder-level" class="p-3 border border-gray-300 rounded-lg w-1/6" placeholder="기본 재주문 수량" value="10" min="0">
                            <button class="bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition w-1/6" onclick="checkPassword('admin', addInventoryItem)">항목 추가</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3">소모품 목록</h3>
                                <ul class="divide-y divide-gray-200">
                                    ${itemRows(window.state.settings.consumables)}
                                </ul>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-3">청소 용품 목록</h3>
                                <ul class="divide-y divide-gray-200">
                                    ${itemRows(window.state.settings.supplies)}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        window.renderReports = () => {
            const logs = window.state.inventoryLogs;
            
            // Function to filter and format logs
            const renderLogTable = (filteredLogs) => {
                if (filteredLogs.length === 0) {
                    return '<p class="text-center text-gray-500 py-6">선택한 기간에 대한 재고 기록이 없습니다.</p>';
                }

                return `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">날짜</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">항목</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">구분</th>
                                    <th class="p-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">수량</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">메모</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${filteredLogs.map(log => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 text-sm text-gray-900">${new Date(log.timestamp.seconds * 1000).toLocaleDateString('ko-KR')}</td>
                                        <td class="p-3 text-sm text-gray-700">${log.itemName}</td>
                                        <td class="p-3 text-sm font-medium ${log.type === 'in' ? 'text-blue-600' : 'text-red-600'}">${log.type === 'in' ? '입고' : '출고'}</td>
                                        <td class="p-3 text-right text-sm font-bold">${log.quantity}</td>
                                        <td class="p-3 text-sm text-gray-500">${log.memo || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold text-blue-600 mb-6 flex items-center">
                        <i data-lucide="clipboard-list" class="w-7 h-7 mr-2"></i>
                        재고 기록 보고서
                    </h2>

                    <div class="flex flex-wrap items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6 p-4 border rounded-lg bg-gray-50">
                        <div class="flex-shrink-0 text-sm font-medium text-gray-700">기간 선택:</div>
                        <input type="date" id="report-start-date" class="p-2 border border-gray-300 rounded-lg">
                        <span>~</span>
                        <input type="date" id="report-end-date" class="p-2 border border-gray-300 rounded-lg">
                        <button class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-800 transition text-sm" onclick="filterLogs()">필터링</button>
                        
                        <div class="sm:ml-auto flex space-x-2">
                            <button class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition text-sm" onclick="exportToExcel()">
                                <i data-lucide="file-text" class="w-5 h-5 inline-block mr-1"></i>
                                엑셀로 내보내기 (시뮬레이션)
                            </button>
                            <button class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition text-sm" onclick="window.print()">
                                <i data-lucide="printer" class="w-5 h-5 inline-block mr-1"></i>
                                인쇄
                            </button>
                        </div>
                    </div>

                    <div id="report-table-container">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">전체 재고 기록 (최신순)</h3>
                        ${renderLogTable(logs)}
                    </div>
                </div>
            `;
        };

        // --- Core Action Functions ---

        /**
         * Cleans up file input and converts file data (simulated as Base64)
         */
        const processFile = (fileInput) => {
            const files = Array.from(fileInput.files).slice(0, 5); // Max 5 files
            const base64Photos = [];
            
            files.forEach(file => {
                // Simplified Base64 conversion for demonstration, as actual FileReader is asynchronous
                // and complex to manage in a single-function structure.
                // For now, we simulate.
                base64Photos.push(`DEMO_BASE64_${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`);
            });
            return base64Photos;
        };
        
        /**
         * Cleans up file input and converts file data (actual Base64 conversion for simple files).
         * NOTE: This simplified version will only successfully encode very small files or placeholders.
         */
        window.previewImages = (input, previewId) => {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            const files = Array.from(input.files).slice(0, 5);

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML += `<img src="${e.target.result}" class="w-16 h-16 object-cover rounded-md shadow">`;
                };
                reader.readAsDataURL(file);
            });
        };
        
        /**
         * Submits a new cleaning request (public access).
         */
        window.submitCleaningRequest = async () => {
            const message = document.getElementById('request-message').value.trim();
            const photoInput = document.getElementById('request-photo-input');
            
            if (!message) {
                window.showMessage('요청 메시지를 입력해 주세요.', 'error');
                return;
            }

            try {
                // Simulate file reading and get Base64 strings
                const requestPhotos = [];
                for (const file of Array.from(photoInput.files).slice(0, 5)) {
                    // This is a simplified, non-awaiting way to get base64. 
                    // For a fully robust solution, use Promises and async/await.
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    requestPhotos.push(base64);
                }
                
                const requestsCollectionRef = getPublicCollectionRef('cleaning_requests');

                await addDoc(requestsCollectionRef, {
                    requestMessage: message,
                    requestPhotos: requestPhotos,
                    status: '대기', // '대기', '작업중', '완료'
                    timestamp: new Date(),
                });

                document.getElementById('request-message').value = '';
                photoInput.value = '';
                document.getElementById('request-preview').innerHTML = '';
                window.showMessage('청소 요청이 성공적으로 제출되었습니다.', 'success');

            } catch (error) {
                console.error("Error adding cleaning request:", error);
                window.showMessage(`요청 제출 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Updates request status to '작업중' (Supervisor/Admin only).
         */
        window.updateRequestStatus = async (requestId, newStatus) => {
            try {
                // 6 segments path: artifacts/{appId}/public/data/cleaning_requests/{requestId} (Correct for Document)
                const requestRef = getPublicConfigDocRef('cleaning_requests', requestId); 
                await updateDoc(requestRef, { status: newStatus });
                window.showMessage(`상태가 ${newStatus}로 변경되었습니다.`, 'success');
            } catch (error) {
                console.error("Error updating request status:", error);
                window.showMessage(`상태 업데이트 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Opens the form to complete a request.
         */
        window.openCompletionForm = (requestId) => {
            const request = window.state.requests.find(r => r.id === requestId);
            
            // Temporary simple modal for completion input
            const completionMessage = prompt(`요청 완료: [${request.requestMessage.substring(0, 20)}...]\n\n완료 메시지를 입력하세요:`);
            
            if (completionMessage !== null) {
                // In a proper app, this would be a full modal with file upload inputs.
                // For this simple example, we ask for a simulated photo count.
                let photoCount = 0;
                let validCount = false;
                while (!validCount) {
                    const countInput = prompt('최대 5개의 완료 사진을 첨부할 수 있습니다. 몇 개의 사진을 첨부하시겠습니까? (0에서 5 사이의 숫자 입력)');
                    photoCount = parseInt(countInput);
                    if (isNaN(photoCount) || photoCount < 0 || photoCount > 5) {
                        alert('0에서 5 사이의 유효한 숫자를 입력하세요.');
                    } else {
                        validCount = true;
                    }
                }
                
                // Simplified Base64 Placeholder
                const completionPhotos = Array(photoCount).fill(`DEMO_COMPLETION_BASE64_${requestId}_`);
                
                window.checkPassword('supervisor', () => completeRequest(requestId, completionMessage, completionPhotos));
            }
        };
        
        /**
         * Marks a request as complete with photos and message (Supervisor/Admin only).
         */
        window.completeRequest = async (requestId, completionMessage, completionPhotos) => {
             try {
                // 6 segments path: artifacts/{appId}/public/data/cleaning_requests/{requestId} (Correct for Document)
                const requestRef = getPublicConfigDocRef('cleaning_requests', requestId);
                await updateDoc(requestRef, { 
                    status: '완료',
                    completionMessage: completionMessage,
                    completionPhotos: completionPhotos,
                    completedAt: new Date(),
                });
                window.showMessage('작업 완료 보고서가 성공적으로 저장되었습니다.', 'success');
            } catch (error) {
                console.error("Error completing request:", error);
                window.showMessage(`완료 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Opens the Inventory In/Out Modal. (Localized to English)
         */
        window.openIOModal = (itemId, itemName) => {
            window.state.inventoryActionContext = { itemId, itemName };
            
            document.getElementById('io-modal-title').textContent = `${itemName} 입/출고`;
            document.getElementById('io-item-name').textContent = itemName;
            document.getElementById('io-quantity').value = 1;
            document.getElementById('io-memo').value = '';

            // Localize Modal Content
            document.querySelector('#io-modal label[for="io-type"]').textContent = '구분';
            document.querySelector('#io-modal option[value="in"]').textContent = '입고';
            document.querySelector('#io-modal option[value="out"]').textContent = '출고';
            document.querySelector('#io-modal label[for="io-quantity"]').textContent = '수량';
            document.getElementById('io-quantity').placeholder = '수량 입력';
            document.querySelector('#io-modal label[for="io-memo"]').textContent = '메모 (선택)';
            document.getElementById('io-memo').placeholder = '간단한 메모';
            document.querySelector('#io-modal button:last-child').textContent = '저장';
            document.querySelector('#io-modal button:first-child').textContent = '취소';
            document.querySelector('#io-modal p.text-gray-600').innerHTML = `현재 항목: <span id="io-item-name" class="font-semibold text-blue-600">${itemName}</span>`;


            const modal = document.getElementById('io-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeIOModal = () => {
            document.getElementById('io-modal').classList.remove('flex');
            document.getElementById('io-modal').classList.add('hidden');
            window.state.inventoryActionContext = null;
        };

        /**
         * Performs the actual inventory log action after password check (Supervisor/Admin only).
         */
        window.performInventoryAction = () => {
            // [FIX 1] checkPassword가 호출되어 비밀번호 모달이 뜰 때,
            // 이 모달(io-modal)은 배경에 숨겨져 있으므로, Z-index 수정으로 해결됩니다.
            window.checkPassword('supervisor', executeInventoryLog);
        };

        window.executeInventoryLog = async () => {
            const context = window.state.inventoryActionContext;
            if (!context) return;

            const type = document.getElementById('io-type').value;
            const quantity = parseInt(document.getElementById('io-quantity').value);
            const memo = document.getElementById('io-memo').value;

            if (isNaN(quantity) || quantity <= 0) {
                window.showMessage('유효한 수량을 입력해 주세요.', 'error');
                return;
            }

            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);

                await addDoc(collection(userDocRef, 'itac_inventory_logs'), {
                    itemId: context.itemId,
                    itemName: context.itemName,
                    type: type, // 'in' or 'out'
                    quantity: quantity,
                    memo: memo,
                    timestamp: new Date(),
                });

                window.showMessage(`${context.itemName} ${type === 'in' ? '입고' : '출고'} ${quantity}개가 성공적으로 기록되었습니다.`, 'success');
                closeIOModal();

            } catch (error) {
                console.error("Error recording inventory log:", error);
                window.showMessage(`재고 기록 오류: ${error.message}`, 'error');
            }
        };
        
        // --- Settings Action Functions (Admin Only) ---
        
        /**
         * Updates Admin/Supervisor Passwords.
         */
        window.updatePasswords = async () => {
            const adminPw = document.getElementById('admin-pw').value;
            const supervisorPw = document.getElementById('supervisor-pw').value;
            
            const newPasswords = { ...window.state.settings.passwords };
            let changes = false;
            
            if (adminPw) {
                newPasswords.admin = adminPw;
                changes = true;
            }
            if (supervisorPw) {
                newPasswords.supervisor = supervisorPw;
                changes = true;
            }

            if (!changes) {
                window.showMessage('변경할 비밀번호를 입력해 주세요.', 'info');
                return;
            }
            
            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                await updateDoc(userDocRef, { passwords: newPasswords });
                window.showMessage('비밀번호가 성공적으로 업데이트되었습니다.', 'success');
                document.getElementById('admin-pw').value = '';
                document.getElementById('supervisor-pw').value = '';
            } catch (error) {
                console.error("Error updating passwords:", error);
                window.showMessage(`비밀번호 업데이트 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Updates Weekly Plan.
         */
        window.updateWeeklyPlan = async () => {
            const newPlan = [];
            for (let i = 0; i < 10; i++) {
                const day = document.getElementById(`plan-day-${i}`).value;
                const task = document.getElementById(`plan-task-${i}`).value;
                newPlan.push({ day, task });
            }
            
            try {
                // Use the 6-segment config document path
                const planDocRef = getPublicConfigDocRef('itac_plan');
                await setDoc(planDocRef, { weeklyPlan: newPlan });
                window.showMessage('주간 청소 계획이 성공적으로 저장되었습니다.', 'success');
            } catch (error) {
                console.error("Error updating weekly plan:", error);
                window.showMessage(`계획 업데이트 오류: ${error.message}`, 'error');
            }
        };
        
        /**
         * Updates Safety Stock Levels.
         */
        window.updateSafetyStock = async () => {
            const allItems = [...window.state.settings.consumables, ...window.state.settings.supplies];
            const newLevels = {};
            
            allItems.forEach(item => {
                const input = document.getElementById(`safety-stock-${item.id}`);
                const value = parseInt(input.value);
                if (!isNaN(value) && value >= 0) {
                    newLevels[item.id] = value;
                }
            });
            
            try {
                // Use the 6-segment config document path
                const safetyStockDocRef = getPublicConfigDocRef('itac_safety_stock');
                await setDoc(safetyStockDocRef, { levels: newLevels });
                window.showMessage('안전 재고 수준이 성공적으로 저장되었습니다.', 'success');
            } catch (error) {
                console.error("Error updating safety stock:", error);
                window.showMessage(`안전 재고 업데이트 오류: ${error.message}`, 'error');
            }
        };


        /**
         * Adds a new inventory item.
         */
        window.addInventoryItem = async () => {
            const name = document.getElementById('new-item-name').value.trim();
            const category = document.getElementById('new-item-category').value;
            const reorderLevel = parseInt(document.getElementById('new-item-reorder-level').value);

            if (!name || isNaN(reorderLevel) || reorderLevel < 0) {
                window.showMessage('항목 이름과 재주문 수량을 정확히 입력해 주세요.', 'error');
                return;
            }
            
            // Generate a simple ID
            const itemId = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now().toString().slice(-4);
            const newItem = { id: itemId, name, category, reorderLevel };

            const currentList = window.state.settings[category];
            if (currentList.some(item => item.name === name)) {
                window.showMessage('항목 이름이 이미 존재합니다.', 'error');
                return;
            }
            
            const newList = [...currentList, newItem];
            
            try {
                const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                await updateDoc(userDocRef, { [category]: newList });
                
                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-reorder-level').value = '10';
                window.showMessage(`${name} (${category === 'consumable' ? '소모품' : '청소 용품'}) 항목이 추가되었습니다.`, 'success');
            } catch (error) {
                console.error("Error adding item:", error);
                window.showMessage(`항목 추가 오류: ${error.message}`, 'error');
            }
        };

        /**
         * Deletes an inventory item.
         */
        window.deleteInventoryItem = async (itemId, category) => {
            window.checkPassword('admin', async () => {
                const currentList = window.state.settings[category];
                const newList = currentList.filter(item => item.id !== itemId);
                
                if (newList.length === currentList.length) {
                    window.showMessage('항목을 찾을 수 없습니다.', 'error');
                    return;
                }
                
                try {
                    const userDocRef = doc(window.db, 'artifacts', appId, 'users', window.userId);
                    await updateDoc(userDocRef, { [category]: newList });
                    window.showMessage(`항목이 성공적으로 삭제되었습니다.`, 'success');
                } catch (error) {
                    console.error("Error deleting item:", error);
                    window.showMessage(`항목 삭제 오류: ${error.message}`, 'error');
                }
            });
        };
        
        // --- Reports Action Functions ---

        /**
         * Filters the inventory logs based on selected date range.
         */
        window.filterLogs = () => {
            const startDateStr = document.getElementById('report-start-date').value;
            const endDateStr = document.getElementById('report-end-date').value;
            const container = document.getElementById('report-table-container');

            let filteredLogs = window.state.inventoryLogs;

            if (startDateStr) {
                const startTimestamp = new Date(startDateStr).getTime();
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp.seconds * 1000).getTime() >= startTimestamp);
            }
            
            if (endDateStr) {
                // Set end date to midnight of the next day to include the entire end day
                const endDate = new Date(endDateStr);
                endDate.setDate(endDate.getDate() + 1);
                const endTimestamp = endDate.getTime();
                
                filteredLogs = filteredLogs.filter(log => new Date(log.timestamp.seconds * 1000).getTime() < endTimestamp);
            }

            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">기간별 재고 기록 (${startDateStr || '전체'} ~ ${endDateStr || '전체'})</h3>
                ${renderLogTable(filteredLogs)}
            `;
            lucide.createIcons();
        };


        /**
         * Simulates Excel export functionality.
         */
        window.exportToExcel = () => {
             // In a real application, you'd use a library like SheetJS or create a proper CSV/XLSX file.
             // Here, we simulate by collecting the log data and prompting a copy.
            
            window.checkPassword('supervisor', () => {
                const logs = window.state.inventoryLogs; // Use all logs for export simulation
                
                const header = ["날짜", "항목", "구분", "수량", "메모"].join('\t');
                const rows = logs.map(log => [
                    new Date(log.timestamp.seconds * 1000).toLocaleDateString('ko-KR'),
                    log.itemName,
                    log.type === 'in' ? '입고' : '출고',
                    log.quantity,
                    log.memo || '-'
                ].join('\t'));

                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [header, ...rows].join('\n');
                
                // Simulate download
                const link = document.createElement('a');
                link.setAttribute('href', csvContent);
                link.setAttribute('download', 'ITAC_Inventory_Report.csv');
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
                
                window.showMessage('Excel 파일 다운로드가 시작되었습니다 (CSV 형식).', 'info');
            });
        };


        // --- Startup ---
        window.onload = window.setupFirebase;
    </script>
</body>
</html>